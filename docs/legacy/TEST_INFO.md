# Test Info Feature - NUI Documentation

## Overview

The **Test Info** tab in NUI provides real-time monitoring and reporting of FBOSS link test execution. It displays test progress, results, and allows downloading of test reports generated by the ExitEVT.sh test script.

## Features

### 1. Real-Time Test Progress Monitoring
- **Auto-refresh**: Updates every 2 seconds while the Test Info tab is active
- **Test Status Detection**: Automatically detects running tests via `/opt/fboss/TEST_STATUS` file
- **Live Test Checklist**: Shows all tests with their current status
  - ✓ PASS - Test completed successfully
  - ✗ FAIL - Test failed
  - ⏳ Testing... - Currently executing
  - ○ Not tested yet - Pending execution

### 2. Test Results Display
- **Summary Statistics**: Shows total passed/failed/total test counts
- **Detailed Results Table**: Lists all tests with their outcomes
- **Test Report Download**: Direct download link for test archive (.tar.gz)

### 3. Live Log Viewer
- **Real-time Log Streaming**: Shows last 100 lines of the test log
- **Auto-refresh**: Updates every 1 second when visible
- **Syntax Highlighting**: Color-coded log output
  - Blue: `[RUN]` markers
  - Green: `[OK]`, `[PASSED]` markers
  - Red: `[FAILED]`, `[ERROR]` markers
  - Yellow: `[WARN]` markers

## Architecture

### Backend (app.py)

#### API Endpoints

##### `/api/test_info`
Returns comprehensive test status information.

**Response Structure:**
```json
{
  "test_running": true,
  "test_completed": false,
  "start_time": "2024-10-18-AM02-50",
  "end_time": "2024-10-18-AM02-50",
  "log_file": "/opt/fboss/link_test_..._BASIC.log",
  "test_list": [
    "AgentEnsembleLinkTest.opticsTxDisableRandomPorts",
    "AgentEnsembleLinkTest.opticsTxDisableEnable"
  ],
  "current_test": "AgentEnsembleLinkTest.opticsTxDisableRandomPorts",
  "passed_tests": ["AgentEnsembleLinkTest.getTransceivers"],
  "failed_tests": ["AgentEnsembleLinkTest.opticsTxDisableRandomPorts"],
  "test_results": {
    "file": "test_results.csv",
    "passed": 10,
    "failed": 2,
    "total": 12,
    "tests": [...]
  }
}
```

**Detection Logic:**
1. **Primary Method**: Reads `/opt/fboss/TEST_STATUS` file
   - Parses `Sart Time:` (start time)
   - Parses `log:` (archive filename)
   - Parses `End Time:` (completion time)
   - Test is running if start time exists but no end time

2. **Fallback Method**: Checks for running processes
   - `run_test.py` process
   - `sai_mono_link_test-sai_impl` process

3. **CSV Results**: Reads completed test results from CSV files in `/opt/fboss/`

##### `/api/test_log_tail?lines=N`
Returns the last N lines of the current test log file.

**Parameters:**
- `lines` (optional, default: 50): Number of lines to retrieve

**Response:**
```json
{
  "log_file": "/opt/fboss/link_test_..._BASIC.log",
  "content": "...log content...",
  "lines": 100
}
```

##### `/api/test_reports`
Lists available test report archives for the current platform.

**Response:**
```json
{
  "reports": [
    {
      "filename": "ExitEVT_WEDGE800BACT_..._2024-10-18-AM02-50.tar.gz",
      "size": 12345678,
      "modified": 1704326400.0,
      "path": "/home/NUI/test_report/WEDGE800BACT/..."
    }
  ],
  "platform": "WEDGE800BACT",
  "report_dir": "/home/NUI/test_report/WEDGE800BACT"
}
```

##### `/api/download_report/<filename>`
Downloads a test report archive.

**Security:**
- Validates filename is within platform report directory
- Prevents directory traversal attacks

### Frontend (NUI.html)

#### Test Status Display
Located in `displayTestStatus()` function:

1. **Completed Tests**: Shows summary cards and results table
2. **Running Tests**: Displays progress checklist and live statistics
3. **No Tests**: Shows placeholder message

#### Auto-Refresh
- **Test Info**: Refreshes every 2 seconds via `setInterval(loadTestInfo, 2000)`
- **Log Viewer**: Refreshes every 1 second when visible
- **Auto-stop**: Stops when switching to another tab

#### Test Checklist Rendering
- Parses test names from log file
- Displays in original sequence from log
- Matches test status using flexible pattern matching
- Groups visually but maintains execution order

## File Structure

### TEST_STATUS File Format
Location: `/opt/fboss/TEST_STATUS`

```
Sart Time:2024-10-18-AM02-50
log:ExitEVT_WEDGE800BACT_fboss_bins_bcm_..._2024-10-18-AM02-50.tar.gz
End Time:2024-10-18-AM02-50
```

**Fields:**
- `Sart Time` or `Start Time`: Test start timestamp
- `log`: Archive filename (not the actual log file)
- `End Time` or `Finsih Tim`: Test completion timestamp

### Log File Naming Convention
**Format**: `link_test_{VERSION}_{DATE}_BASIC.log`

**Example**:
```
link_test_fboss_bins_bcm_JC_20251222_15_54_08_b43cb9b8f5_varFBOSSsai_SAI_13_3_0_GA_20251210_tar_gz.tar.zst_2024-10-18-AM02-50_BASIC.log
```

**Derivation from TEST_STATUS**:
```
Archive: ExitEVT_PLATFORM_VERSION_DATE.tar.gz
Log:     link_test_VERSION_DATE_BASIC.log
```

### Test Report Archives
**Location**: `/home/NUI/test_report/{PLATFORM}/`

**Contents**:
- CSV result files
- Excel (XLSX) result files
- `fboss2_show_port.txt`
- `fboss2_show_transceivers.txt`
- `Version_Info.txt`
- Log archives (`*.log.tar.gz`)
- Configuration files

## Log Parsing

### Test List Extraction
The backend parses the test plan from the beginning of the log file:

**Format**:
```
AgentEnsembleLinkTest.
  opticsTxDisableRandomPorts
  opticsTxDisableEnable
  getTransceivers
```

**Parsing Logic**:
1. Match class names ending with `.` (e.g., `AgentEnsembleLinkTest.`)
2. Match indented method names (e.g., `  opticsTxDisableRandomPorts`)
3. Combine to form full test name: `AgentEnsembleLinkTest.opticsTxDisableRandomPorts`

### Test Results Extraction

**Passed Tests Pattern**:
```regex
\[\s*(?:OK|PASSED)\s*\]\s+(?:(?:warm_boot|cold_boot)\.)?(\w+\.\w+)\s+\(\d+\s+ms\)
```

**Failed Tests Pattern**:
```regex
\[\s*(?:FAILED|FAIL)\s*\]\s+(?:(?:warm_boot|cold_boot)\.)?(\w+\.\w+)\s+\(\d+\s+ms\)
```

**Features**:
- Strips `warm_boot.` and `cold_boot.` prefixes
- Excludes header lines (starting with `#`)
- Matches only actual test results (with timing)
- Deduplicates results (same test may run multiple times)

**Example Log Lines**:
```
[       OK ] warm_boot.AgentEnsembleLinkTest.getTransceivers (251907 ms)
[  FAILED  ] cold_boot.AgentEnsembleLinkTest.opticsTxDisableRandomPorts (333482 ms)
```

**Captured**: `AgentEnsembleLinkTest.getTransceivers`, `AgentEnsembleLinkTest.opticsTxDisableRandomPorts`

**Excluded Lines**:
```
########## Coldboot test results (1/2): [   FAILED ] cold_boot.AgentEnsembleLinkTest.opticsTxDisableRandomPorts (0 ms)
[  FAILED  ] 1 test, listed below:
```

## Usage

### Starting a Test
Tests are started externally via `ExitEVT.sh` script:
```bash
cd /opt/fboss
./ExitEVT.sh <zst_version> <topology_name> [test_cases]
```

**What Happens**:
1. Script creates `/opt/fboss/TEST_STATUS` with start time
2. Runs test suite via `run_test.py`
3. Logs output to `link_test_..._BASIC.log`
4. Creates test report archive
5. Updates TEST_STATUS with log archive name and end time
6. Moves archive to `/home/NUI/test_report/{PLATFORM}/`

### Viewing Test Progress in NUI
1. Open NUI in browser: `http://<device-ip>:5000`
2. Click **Test Info** tab
3. View real-time test progress
4. Monitor passed/failed counts
5. Click **Show Log** to view live output

### Downloading Test Reports
1. Test completes
2. Download button appears automatically
3. Click **⬇ Download** to get the `.tar.gz` archive
4. Archive contains all test results and logs

## Configuration

### Auto-Refresh Settings
In `NUI.html`:
```javascript
// Test info refresh interval (2 seconds)
testInfoInterval = setInterval(loadTestInfo, 2000);

// Log viewer refresh interval (1 second)
logViewerInterval = setInterval(refreshLogViewer, 1000);
```

### Platform Detection
Platform is auto-detected via `get_platform_name()` in `app.py`:
- Reads from fruid or other platform detection methods
- Used to locate test reports in `/home/NUI/test_report/{PLATFORM}/`

## Troubleshooting

### "No Test Results Available"
**Causes**:
- No CSV files in `/opt/fboss/`
- No TEST_STATUS file exists
- No test processes running

**Solutions**:
- Verify test has been run via `ExitEVT.sh`
- Check for TEST_STATUS: `cat /opt/fboss/TEST_STATUS`
- Check for logs: `ls -l /opt/fboss/*.log`

### "Error: Log file not found"
**Causes**:
- Log file has been archived (`.tar.gz`)
- TEST_STATUS has incorrect log path
- Log file deleted

**Solutions**:
- Check log exists: `ls -l /opt/fboss/link_test_*.log`
- Check archived logs: `ls -l /opt/fboss/*.log.tar.gz`
- Verify TEST_STATUS content matches actual files

### Test Status Not Updating
**Causes**:
- Auto-refresh disabled
- JavaScript errors in console
- Network connectivity issues

**Solutions**:
- Check browser console for errors (F12)
- Refresh page manually
- Verify Flask server is running: `ps aux | grep python.*app.py`

### Duplicate Tests in Results
**Causes**:
- Same test run multiple times (cold_boot, warm_boot)
- Log contains retries

**Solutions**:
- Already handled by deduplication logic
- Only first occurrence is displayed

## Examples

### Example TEST_STATUS
```
Sart Time:2026-01-03-AM09-10
log:ExitEVT_WEDGE800BACT_fboss_bins_bcm_JC_20251222_15_54_08_b43cb9b8f5_varFBOSSsai_SAI_13_3_0_GA_20251210_tar_gz.tar.zst_2026-01-03-AM09-10.tar.gz
End Time:2026-01-03-AM09-11
```

### Example Log Output
```
The --skip-known-bad-tests option is not set, therefore unsupported tests will be run.
AgentEnsembleOpticsTest.
  verifyTxRxLatches
AgentEnsembleLinkTest.
  ecmpShrink
  asicLinkFlap
  getTransceivers
  
[==========] Running 3 tests from 2 test suites.
[----------] 1 test from AgentEnsembleOpticsTest
[ RUN      ] AgentEnsembleOpticsTest.verifyTxRxLatches
[       OK ] AgentEnsembleOpticsTest.verifyTxRxLatches (251907 ms)
[----------] 2 tests from AgentEnsembleLinkTest
[ RUN      ] AgentEnsembleLinkTest.ecmpShrink
[       OK ] AgentEnsembleLinkTest.ecmpShrink (125432 ms)
[ RUN      ] AgentEnsembleLinkTest.asicLinkFlap
[  FAILED  ] AgentEnsembleLinkTest.asicLinkFlap (89234 ms)
[==========] 3 tests from 2 test suites ran. (466573 ms total)
[  PASSED  ] 2 tests.
[  FAILED  ] 1 test, listed below:
[  FAILED  ] AgentEnsembleLinkTest.asicLinkFlap
```

### Example API Response
```bash
curl http://localhost:5000/api/test_info
```

```json
{
  "test_running": true,
  "start_time": "2026-01-03-AM09-10",
  "log_file": "/opt/fboss/link_test_fboss_bins_bcm_..._2026-01-03-AM09-10_BASIC.log",
  "test_list": [
    "AgentEnsembleOpticsTest.verifyTxRxLatches",
    "AgentEnsembleLinkTest.ecmpShrink",
    "AgentEnsembleLinkTest.asicLinkFlap"
  ],
  "current_test": "AgentEnsembleLinkTest.asicLinkFlap",
  "passed_tests": [
    "AgentEnsembleOpticsTest.verifyTxRxLatches",
    "AgentEnsembleLinkTest.ecmpShrink"
  ],
  "failed_tests": []
}
```

## Version History

- **v0.0.0.22**: Initial Test Info implementation
  - Real-time test monitoring
  - TEST_STATUS file integration
  - Auto-refresh (2 seconds)
  - Live log viewer
  - Test report download
  - Duplicate test filtering
  - cold_boot/warm_boot prefix stripping

## See Also

- [ExitEVT.sh](../test_script/ExitEVT.sh) - Test execution script
- [WORKFLOW.md](WORKFLOW.md) - Overall NUI workflow
- [SPEC.md](SPEC.md) - NUI specification
