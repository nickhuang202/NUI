<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVARUNTAR - Lab Monitor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4/dist/exceljs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3d5a6c 50%, #2c3e50 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(52, 73, 94, 0.8);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #5cb85c;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .header p {
            color: #95a5a6;
            font-size: 14px;
            letter-spacing: 1px;
        }

        .lab-status-button {
            display: inline-block;
            padding: 12px 30px;
            margin: 20px 10px 10px;
            background: #5cb85c;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .lab-status-button:hover {
            background: #4cae4c;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(92, 184, 92, 0.4);
        }

        .config-button {
            background: #3498db;
        }

        .config-button:hover {
            background: #2980b9;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .switch-mode-button {
            background: #e67e22;
        }

        .switch-mode-button:hover {
            background: #d35400;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .controls button {
            padding: 12px 25px;
            margin: 0 10px;
            background: #5cb85c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .controls button:hover {
            background: #4cae4c;
            transform: translateY(-2px);
        }

        .lab-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .lab-group {
            background: rgba(52, 73, 94, 0.9);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(92, 184, 92, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .lab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(92, 184, 92, 0.3);
        }

        .lab-title {
            font-size: 24px;
            font-weight: 700;
            color: #5cb85c;
        }

        .lab-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            background: rgba(52, 152, 219, 0.8);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: rgba(52, 152, 219, 1);
        }

        .action-btn.delete {
            background: rgba(231, 76, 60, 0.8);
        }

        .action-btn.delete:hover {
            background: rgba(231, 76, 60, 1);
        }

        .platforms-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 100px;
        }

        .platform-group {
            background: rgba(44, 62, 80, 0.8);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(149, 165, 166, 0.3);
            cursor: move;
        }

        .platform-group.dragging {
            opacity: 0.5;
        }

        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .platform-title {
            font-size: 18px;
            font-weight: 600;
            color: #3498db;
        }

        .duts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 60px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            margin-top: 10px;
        }

        .dut-item {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: move;
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dut-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(74, 85, 104, 0.6);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .dut-item.dragging {
            opacity: 0.5;
        }

        .dut-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .dut-name {
            font-size: 14px;
            font-weight: 600;
        }

        .dut-version {
            font-size: 11px;
            opacity: 0.8;
            font-weight: 400;
        }

        .dut-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dut-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        .dut-config {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 2px solid white;
            flex-shrink: 0;
        }

        .dut-config.config-a {
            background: #f1c40f;
        }

        .dut-config.config-b {
            background: #2ecc71;
        }

        .dut-config.config-c {
            background: #3498db;
        }

        .dut-status {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .dut-status.online {
            background: #2ecc71;
        }

        .dut-status.offline {
            background: #e74c3c;
        }

        .dut-status.testing {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .dut-item.has-new-report {
            position: relative;
            animation: glow 2s infinite;
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 2px 5px rgba(243, 156, 18, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.8), 0 0 30px rgba(52, 152, 219, 0.6);
            }
        }

        .new-report-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid white;
            z-index: 10;
            animation: bounce 1s infinite;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .new-report-badge:hover {
            background: #2980b9;
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .dut-actions {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(44, 62, 80, 0.95);
            border-radius: 5px;
            padding: 5px;
            margin-top: 5px;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .dut-item:hover .dut-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn.sync {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .action-btn.sync:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
        }

        .sortable-ghost {
            opacity: 0.4;
            background: rgba(52, 152, 219, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        /* Trend modal needs higher z-index to appear above dashboard modal */
        #reportTrendModal {
            z-index: 11000;
        }

        /* Log detail modal needs highest z-index to appear above all */
        #reportLogDetailModal {
            z-index: 12000;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(52, 73, 94, 0.98);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px 30px;
            background: rgba(52, 73, 94, 0.95);
            border-bottom: 2px solid rgba(92, 184, 92, 0.3);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .modal-header h2 {
            margin: 0;
            padding: 0;
            border: none;
            color: #5cb85c;
            font-size: 24px;
            flex: 1;
        }

        .modal-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-right: 20px;
        }

        .sort-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 2px solid rgba(92, 184, 92, 0.3);
            background: rgba(52, 73, 94, 0.6);
            color: #e8ecef;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            border-color: #5cb85c;
            background: rgba(92, 184, 92, 0.2);
            color: #5cb85c;
        }

        .sort-btn.active {
            background: linear-gradient(135deg, #5cb85c 0%, #4caf50 100%);
            color: #ffffff;
            border-color: #5cb85c;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #5cb85c;
            transform: scale(1.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ecf0f1;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(149, 165, 166, 0.3);
            border-radius: 5px;
            background: rgba(44, 62, 80, 0.8);
            color: white;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .modal-actions button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #5cb85c;
            color: white;
        }

        .btn-primary:hover {
            background: #4cae4c;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .legend {
            background: rgba(52, 73, 94, 0.8);
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
            text-align: center;
        }

        .legend-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #5cb85c;
        }

        .legend-items {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: rgba(46, 204, 113, 0.95);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .notification.show {
            display: block;
        }

        .notification.error {
            background: rgba(231, 76, 60, 0.95);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .copy-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background: rgba(52, 152, 219, 0.95);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            font-size: 14px;
            font-weight: 600;
        }

        .copy-hint.show {
            display: block;
            animation: pulse 1.5s infinite;
        }

        .sortable-ghost.copying {
            opacity: 0.8;
            border: 2px dashed #3498db;
        }

        .debug-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 600px;
            max-height: 400px;
            background: #1a1a1a;
            border: 2px solid #3498db;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            animation: slideInUp 0.3s ease-out;
        }

        .debug-header {
            padding: 12px 16px;
            background: #3498db;
            color: white;
            font-weight: bold;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-content {
            padding: 12px;
            overflow-y: auto;
            max-height: 350px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ecf0f1;
            background: #1a1a1a;
        }

        .debug-log-entry {
            padding: 6px 10px;
            margin-bottom: 4px;
            border-left: 3px solid #95a5a6;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            word-wrap: break-word;
        }

        .debug-log-entry.info {
            border-left-color: #3498db;
        }

        .debug-log-entry.success {
            border-left-color: #2ecc71;
        }

        .debug-log-entry.warning {
            border-left-color: #f39c12;
        }

        .debug-log-entry.error {
            border-left-color: #e74c3c;
        }

        .debug-log-timestamp {
            color: #95a5a6;
            font-size: 10px;
            margin-right: 8px;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .version-display {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
            padding: 6px 12px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 6px;
        }

        /* Detail Table Styles */
        .detail-table-container {
            margin: 30px 0;
            width: 100%;
            background: rgba(52, 73, 94, 0.9);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid rgba(92, 184, 92, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .detail-table-header {
            font-size: 24px;
            font-weight: 700;
            color: #5cb85c;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(92, 184, 92, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(44, 62, 80, 0.8);
        }

        .detail-table thead {
            background: rgba(52, 73, 94, 0.95);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .detail-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #5cb85c;
            border-bottom: 2px solid rgba(92, 184, 92, 0.3);
            white-space: nowrap;
        }

        .detail-table td {
            padding: 12px;
            font-size: 13px;
            color: #ecf0f1;
            border-bottom: 1px solid rgba(149, 165, 166, 0.2);
        }

        .detail-table tbody tr {
            transition: all 0.3s;
        }

        .detail-table tbody tr:hover {
            background: rgba(52, 73, 94, 0.6);
        }

        .detail-table tbody tr:last-child td {
            border-bottom: none;
        }

        .table-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }

        .table-status-badge.online {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid #2ecc71;
        }

        .table-status-badge.offline {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .table-status-badge.testing {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
            animation: pulse 1.5s infinite;
        }

        .table-btn {
            padding: 6px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 3px;
        }

        .table-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .table-btn.secondary {
            background: #95a5a6;
        }

        .table-btn.secondary:hover {
            background: #7f8c8d;
        }

        .table-new-report {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .table-new-report:hover {
            background: rgba(52, 152, 219, 0.1);
            color: #2980b9;
        }

        .table-new-report-badge {
            background: #3498db;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header" style="position: relative;">
        <h1>AVARUNTAR</h1>
        <p>Acction Versatile Automated RUN Testing And Reporting</p>
        <div class="version-display" id="versionDisplay"></div>
        <a class="lab-status-button switch-mode-button" href="/?mode=normal">Switch to Normal Mode</a>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button onclick="showAddLabModal()">+ Add Lab Group</button>
        <button onclick="loadConfig()">üîÑ Refresh</button>
        <button onclick="checkAllInOne()">üîç Check All (Status + Versions + Reports)</button>
        <span id="statusCheckerInfo" style="margin-left: 15px; font-size: 12px; color: #95a5a6;"></span>
    </div>

    <!-- Lab Container -->
    <div id="labContainer" class="lab-container">
        <div class="empty-state">
            <p>No labs configured. Click "Add Lab Group" to get started.</p>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-title">Legend</div>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-icon" style="background: #f1c40f;"></div>
                <span>Config A</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #2ecc71;"></div>
                <span>Config B</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #3498db;"></div>
                <span>Config C</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #2ecc71;"></div>
                <span>Online</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #e74c3c;"></div>
                <span>Offline</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #f39c12; animation: pulse 1.5s infinite;"></div>
                <span>Testing</span>
            </div>
        </div>
        <div
            style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); color: #3498db; font-size: 14px;">
            üí° <strong>Tip:</strong> Hold <kbd
                style="padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">Ctrl</kbd> (or <kbd
                style="padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">‚åò Cmd</kbd> on Mac)
            while dragging to <strong>copy</strong> instead of move
        </div>
    </div>

    <!-- Detail Information Table -->
    <div id="detailTableContainer" class="detail-table-container">
        <div class="detail-table-header">
            <span id="detailTableTitle">Lab / Platform / DUT Details</span>
        </div>
        <div class="detail-table-wrapper">
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>Lab Name</th>
                        <th>Platform</th>
                        <th>SN</th>
                        <th>Version</th>
                        <th>IP</th>
                        <th>New Report</th>
                        <th>Online/Offline</th>
                        <th>Under Testing</th>
                        <th>Report</th>
                        <th>Schedule Test</th>
                    </tr>
                </thead>
                <tbody id="detailTableBody">
                    <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Lab Modal -->
    <div id="labModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="labModalTitle">Add Lab Group</div>
            <div class="form-group">
                <label for="labName">Lab Name *</label>
                <input type="text" id="labName" placeholder="e.g., LAB A" required>
            </div>
            <div class="form-group">
                <label for="labDescription">Description</label>
                <textarea id="labDescription" placeholder="Optional description"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeLabModal()">Cancel</button>
                <button class="btn-primary" onclick="saveLabModal()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Platform Modal -->
    <div id="platformModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="platformModalTitle">Add Platform Group</div>
            <div class="form-group">
                <label for="platformName">Platform Name *</label>
                <input type="text" id="platformName" placeholder="e.g., Platform A" required>
            </div>
            <div class="form-group">
                <label for="platformDescription">Description</label>
                <textarea id="platformDescription" placeholder="Optional description"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closePlatformModal()">Cancel</button>
                <button class="btn-primary" onclick="savePlatformModal()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit DUT Modal -->
    <div id="dutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="dutModalTitle">Add DUT</div>
            <div class="form-group">
                <label for="dutName">DUT Name *</label>
                <input type="text" id="dutName" placeholder="e.g., DUT A" required>
            </div>
            <div class="form-group">
                <label for="dutIp">IP Address</label>
                <input type="text" id="dutIp" placeholder="e.g., 192.168.1.100">
            </div>
            <div class="form-group">
                <label for="dutPassword">SCP Password</label>
                <input type="password" id="dutPassword" placeholder="Password for SCP login (optional)">
            </div>
            <div class="form-group">
                <label for="dutConfig">Config Type</label>
                <select id="dutConfig">
                    <option value="Config A">Config A</option>
                    <option value="Config B">Config B</option>
                    <option value="Config C">Config C</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dutDescription">Description</label>
                <textarea id="dutDescription" placeholder="Optional description"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeDutModal()">Cancel</button>
                <button class="btn-primary" onclick="saveDutModal()">Save</button>
            </div>
        </div>
    </div>
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Copy Hint -->
    <div id="copyHint" class="copy-hint">
        üîµ Copy Mode: Release Ctrl/Cmd to Move
    </div>

    <!-- Debug Window -->
    <div id="debugWindow" class="debug-window" style="display: none;">
        <div class="debug-header">
            <span>üîç Sync Debug Log</span>
            <div>
                <button onclick="clearDebugLog()"
                    style="margin-right: 10px; padding: 5px 10px; background: #e74c3c; border: none; border-radius: 4px; color: white; cursor: pointer;">Clear</button>
                <button onclick="closeDebugWindow()"
                    style="padding: 5px 10px; background: #95a5a6; border: none; border-radius: 4px; color: white; cursor: pointer;">Close</button>
            </div>
        </div>
        <div id="debugContent" class="debug-content"></div>
    </div>

    <!-- Sync Progress Modal -->
    <div id="syncModal" class="modal">
        <div class="modal-content">
            <h2 id="syncModalTitle">Syncing Report</h2>
            <div style="margin: 20px 0;">
                <div style="margin-bottom: 10px; color: #95a5a6; font-size: 14px;" id="syncMessage">Preparing...</div>
                <div
                    style="width: 100%; background: #2c3e50; border-radius: 10px; overflow: hidden; height: 30px; position: relative;">
                    <div id="syncProgressBar"
                        style="width: 0%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        <span id="syncProgressText">0%</span>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button id="syncCloseBtn" onclick="closeSyncModal()"
                    style="padding: 10px 20px; background: #95a5a6; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 14px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Report Dashboard Modal - Fullscreen -->
    <div id="reportDashboardModal" class="modal" style="z-index: 10000;">
        <div
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #2c3e50 0%, #3d5a6c 50%, #2c3e50 100%); overflow-y: auto;">
            <!-- Header -->
            <div
                style="position: sticky; top: 0; z-index: 1000; background: rgba(52, 73, 94, 0.98); border-bottom: 2px solid rgba(92, 184, 92, 0.3); padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="closeReportModal()"
                            style="background: linear-gradient(135deg, #5cb85c 0%, #4a9d4a 100%); border: none; color: white; font-size: 14px; font-weight: 600; cursor: pointer; padding: 10px 20px; border-radius: 8px; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'">
                            ‚Üê Back to Lab Monitor
                        </button>
                        <h1 id="reportModalTitle" style="margin: 0; color: #ffffff; font-size: 28px; font-weight: 600;">
                            Test
                            Report Dashboard</h1>
                    </div>
                    <button onclick="closeReportModal()"
                        style="background: transparent; border: none; color: #95a5a6; font-size: 36px; cursor: pointer; padding: 0; width: 45px; height: 45px; line-height: 1; transition: all 0.3s;"
                        onmouseover="this.style.color='#5cb85c'; this.style.transform='scale(1.2)'"
                        onmouseout="this.style.color='#95a5a6'; this.style.transform='scale(1)'">√ó</button>
                </div>
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div
                        style="display: flex; align-items: center; background: rgba(76, 175, 80, 0.2); border: 2px solid #4CAF50; border-radius: 8px; padding: 8px 15px;">
                        <span style="color: #4CAF50; font-weight: bold; margin-right: 8px;">üìç</span>
                        <span id="reportPlatformDisplay"
                            style="color: #4CAF50; font-weight: bold; font-size: 16px;"></span>
                    </div>
                    <div class="date-picker-container" style="position: relative; display: inline-block;">
                        <input type="text" id="reportDateInput" class="date-input" readonly placeholder="Select Date..."
                            onclick="toggleReportCalendar()"
                            style="padding: 10px 15px; font-size: 14px; border: 2px solid rgba(92, 184, 92, 0.5); border-radius: 8px; background: rgba(52, 73, 94, 0.6); color: #ffffff; cursor: pointer; font-weight: 600; min-width: 150px;">
                        <div id="reportCalendarPopup" class="calendar-popup"
                            style="display: none; position: absolute; top: 50px; right: 0; z-index: 9999; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); border: 2px solid #5cb85c; border-radius: 12px; padding: 15px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); min-width: 320px;">
                            <div class="calendar-header"
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: #ecf0f1;">
                                <button class="calendar-nav-btn" onclick="reportPreviousMonth()"
                                    style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px 10px;">‚óÄ</button>
                                <span id="reportCurrentMonthYear"
                                    style="flex: 1; text-align: center; font-weight: bold; font-size: 14px;"></span>
                                <button class="calendar-nav-btn" onclick="reportNextMonth()"
                                    style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px 10px;">‚ñ∂</button>
                            </div>
                            <div id="reportCalendarGrid"
                                style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                                <div class="calendar-weekday"
                                    style="text-align: center; font-weight: bold; font-size: 12px; color: #95a5a6; padding: 8px 0;">
                                    S</div>
                                <div class="calendar-weekday"
                                    style="text-align: center; font-weight: bold; font-size: 12px; color: #95a5a6; padding: 8px 0;">
                                    M</div>
                                <div class="calendar-weekday"
                                    style="text-align: center; font-weight: bold; font-size: 12px; color: #95a5a6; padding: 8px 0;">
                                    T</div>
                                <div class="calendar-weekday"
                                    style="text-align: center; font-weight: bold; font-size: 12px; color: #95a5a6; padding: 8px 0;">
                                    W</div>
                                <div class="calendar-weekday"
                                    style="text-align: center; font-weight: bold; font-size: 12px; color: #95a5a6; padding: 8px 0;">
                                    T</div>
                                <div class="calendar-weekday"
                                    style="text-align: center; font-weight: bold; font-size: 12px; color: #95a5a6; padding: 8px 0;">
                                    F</div>
                                <div class="calendar-weekday"
                                    style="text-align: center; font-weight: bold; font-size: 12px; color: #95a5a6; padding: 8px 0;">
                                    S</div>
                            </div>
                        </div>
                    </div>
                    <span id="reportLoadingIndicator"
                        style="color: #3498db; display: none; margin-left: 10px; font-weight: 600;">Loading...</span>
                </div>
            </div>

            <!-- Content -->
            <div id="reportDashboardContent" style="padding: 30px; max-width: 1600px; margin: 0 auto;">
                <!-- Dashboard content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Trend Modal (for Report) -->
    <div id="reportTrendModal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1800px; overflow-x: hidden;">
            <div class="modal-header">
                <h2 id="reportTrendModalTitle">Test Results Trend</h2>
                <div class="modal-controls">
                    <button class="sort-btn active" onclick="changeReportTrendRange('week')"
                        id="reportTrendWeek">Week</button>
                    <button class="sort-btn" onclick="changeReportTrendRange('month')"
                        id="reportTrendMonth">Month</button>
                    <button class="sort-btn" onclick="changeReportTrendRange('year')" id="reportTrendYear">Year</button>
                    <button class="sort-btn" onclick="exportReportTrendToExcel()"
                        style="background-color: #28a745; border-color: #28a745; color: white;">Export Excel</button>
                </div>
                <span class="close" onclick="closeReportTrendModal()">&times;</span>
            </div>

            <div class="modal-body">
                <div id="reportTopCloseDetailsContainer" style="display: none; text-align: right; margin-bottom: 5px;">
                    <button onclick="closeReportTrendDetails()" class="note-cancel-btn"
                        style="padding: 6px 16px; font-size: 13px;">Close Details</button>
                </div>
                <div style="height: 400px; margin-bottom: 30px;">
                    <canvas id="reportTrendChart"></canvas>
                </div>

                <!-- Details Section (shown when clicking on a point) -->
                <div id="reportTrendDetailsSection" style="display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(92, 184, 92, 0.3);">
                        <h3 id="reportTrendDetailTitle" style="margin: 0;"></h3>
                    </div>

                    <!-- Version Info -->
                    <div id="reportTrendVersionInfoSection"
                        style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #5cb85c;" id="reportTrendVersionTitle">Version Info</h4>
                        <div id="reportTrendVersionContent"></div>
                    </div>

                    <!-- Version Info -->
                    <div id="reportTrendVersionInfoSection"
                        style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #5cb85c;" id="reportTrendVersionTitle">Version Info</h4>
                        <div id="reportTrendVersionContent"></div>
                    </div>

                    <!-- Trend Diff Section -->
                    <div id="reportTrendDiffSection"
                        style="display: none; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed rgba(255, 255, 255, 0.3);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">Diff with Previous Day</h3>
                            <button onclick="closeReportTrendDiff()" class="note-cancel-btn"
                                style="padding: 4px 12px; font-size: 12px;">Close Diff</button>
                        </div>

                        <div id="reportTrendDiffLoading" style="text-align: center; padding: 20px; display: none;">
                            <div
                                style="display: inline-block; width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;">
                            </div>
                            <p>Loading diff data...</p>
                        </div>

                        <div id="reportTrendDiffContent" style="display: none;">
                            <!-- New Failures -->
                            <div
                                style="margin-bottom: 20px; background: rgba(217, 83, 79, 0.1); padding: 15px; border-radius: 6px; border: 1px solid rgba(217, 83, 79, 0.3);">
                                <h4 style="color: #ff6b6b; margin-top: 0; margin-bottom: 10px;">New Failures (<span
                                        id="reportDiffNewFailCount">0</span>)</h4>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table class="test-table">
                                        <thead>
                                            <tr>
                                                <th>Test Name</th>
                                                <th>Category / Level</th>
                                                <th>Start</th>
                                                <th>End</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reportDiffNewFailBody"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Fixed Items -->
                            <div
                                style="background: rgba(92, 184, 92, 0.1); padding: 15px; border-radius: 6px; border: 1px solid rgba(92, 184, 92, 0.3);">
                                <h4 style="color: #5cb85c; margin-top: 0; margin-bottom: 10px;">Fixed (<span
                                        id="reportDiffFixedCount">0</span>)</h4>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table class="test-table">
                                        <thead>
                                            <tr>
                                                <th>Test Name</th>
                                                <th>Category / Level</th>
                                                <th>Start</th>
                                                <th>End</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reportDiffFixedBody"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Test Changes (Added/Removed) -->
                            <div
                                style="background: rgba(91, 192, 222, 0.1); padding: 15px; border-radius: 6px; border: 1px solid rgba(91, 192, 222, 0.3); margin-top: 15px;">
                                <h4 style="color: #5bc0de; margin-top: 0; margin-bottom: 10px;">Test Changes (+<span
                                        id="reportDiffAddedCount">0</span> / -<span
                                        id="reportDiffRemovedCount">0</span>)</h4>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table class="test-table">
                                        <thead>
                                            <tr>
                                                <th>Test Name</th>
                                                <th>Category / Level</th>
                                                <th>Type</th>
                                                <th>Result</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reportDiffChangesBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Items Table -->
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="test-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">#</th>
                                    <th>Test Name</th>
                                    <th style="width: 120px;">Result</th>
                                </tr>
                            </thead>
                            <tbody id="reportTrendDetailsBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Details Modal (for Report) -->
    <div id="reportTestModal" class="modal" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 95%; width: 1800px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="reportModalTestTitle" style="flex: 1; text-align: center; margin: 0;">Test Details</h2>
                <div class="modal-controls">
                    <button id="reportSortAll" class="sort-btn active" onclick="reportSortTests('all')">All</button>
                    <button id="reportSortPass" class="sort-btn" onclick="reportSortTests('pass')">Pass</button>
                    <button id="reportSortFail" class="sort-btn" onclick="reportSortTests('fail')">Fail</button>
                </div>
                <span class="close" onclick="closeReportTestModal()">&times;</span>
            </div>
            <div class="modal-body">
                <table class="test-table" id="reportTestDetailsTable">
                    <thead>
                        <tr>
                            <th style="width: 80px;">#</th>
                            <th>Test Name</th>
                            <th style="width: 120px;">Result</th>
                            <th style="width: 300px;">Note Content</th>
                            <th style="width: 150px;">Action</th>
                            <th style="width: 150px;" id="reportLogDetailHeader">LOG DETAIL</th>
                        </tr>
                    </thead>
                    <tbody id="reportTestDetailsBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div id="reportDownloadSection"
                    style="margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(92, 184, 92, 0.3); text-align: center; display: flex; gap: 15px; justify-content: center;">
                    <button onclick="downloadReportTableAsCSV()" class="download-btn"
                        style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); text-decoration: none; border: none; cursor: pointer; padding: 12px 28px; color: white; border-radius: 8px; font-weight: 600; font-size: 15px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Download CSV
                    </button>
                    <button onclick="downloadReportTestLog()" class="download-btn"
                        style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); text-decoration: none; border: none; cursor: pointer; padding: 12px 28px; color: white; border-radius: 8px; font-weight: 600; font-size: 15px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Editor Modal (for Report) -->
    <div id="reportNoteEditorModal" class="modal" style="z-index: 10002;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Note</h2>
                <span class="close" onclick="closeReportNoteEditor()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label style="color: #95a5a6; font-size: 13px; display: block; margin-bottom: 5px;">Test
                        Name:</label>
                    <div id="reportNoteTestName"
                        style="color: white; font-weight: bold; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                    </div>
                </div>
                <div>
                    <label style="color: #95a5a6; font-size: 13px; display: block; margin-bottom: 5px;">Note:</label>
                    <textarea id="reportNoteEditorTextarea" class="note-editor-textarea"
                        placeholder="Enter your note here..."></textarea>
                </div>
                <div class="note-editor-actions">
                    <button class="note-cancel-btn" onclick="closeReportNoteEditor()">Cancel</button>
                    <button class="note-save-btn" onclick="saveReportNote()">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Report Modal Specific Styles */
        #reportDashboardModal .report-card {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        #reportDashboardModal .report-card h2 {
            margin-top: 0;
            color: #ffffff;
            font-size: 22px;
            font-weight: 600;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(92, 184, 92, 0.3);
        }

        #reportDashboardModal .report-version-table {
            width: 100%;
            border-collapse: collapse;
        }

        #reportDashboardModal .report-version-table td {
            padding: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #e8ecef;
        }

        #reportDashboardModal .report-version-table td:first-child {
            font-weight: 600;
            color: #5cb85c;
            width: 250px;
        }

        #reportDashboardModal .test-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-top: 25px;
        }

        @media (max-width: 1200px) {
            #reportDashboardModal .test-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            #reportDashboardModal .test-grid {
                grid-template-columns: 1fr;
            }
        }

        #reportDashboardModal .test-card {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #reportDashboardModal .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
            border-color: rgba(92, 184, 92, 0.5);
        }

        #reportDashboardModal .test-card.clickable {
            cursor: pointer;
        }

        #reportDashboardModal .test-card h3 {
            margin: 0 0 15px 0;
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
        }

        #reportDashboardModal .test-time {
            display: block;
            color: #FFD700;
            font-size: 13px;
            font-weight: 600;
            margin: 5px 0 15px 0;
            background: rgba(255, 215, 0, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }

        #reportDashboardModal .chart-container {
            position: relative;
            height: 240px;
            width: 240px;
            margin: 0 auto;
        }

        #reportDashboardModal .chart-svg {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        #reportDashboardModal .chart-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        #reportDashboardModal .chart-percentage {
            font-size: 36px;
            font-weight: bold;
            color: #ffffff;
        }

        #reportDashboardModal .chart-total {
            font-size: 14px;
            color: #95a5a6;
            margin-top: 5px;
        }

        #reportDashboardModal .test-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        #reportDashboardModal .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #reportDashboardModal .stat-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        #reportDashboardModal .stat-label {
            color: #e8ecef;
            font-weight: 600;
            font-size: 14px;
        }

        /* Note functionality styles */
        .note-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .note-btn:hover {
            background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        .note-btn.has-note {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }

        .note-btn.has-note:hover {
            background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%);
        }

        .note-editor-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            resize: vertical;
        }

        .note-editor-textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .note-editor-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .note-save-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .note-save-btn:hover {
            background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .note-cancel-btn {
            padding: 10px 24px;
            background: rgba(52, 73, 94, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .note-cancel-btn:hover {
            background: rgba(52, 73, 94, 1);
            border-color: #95a5a6;
        }

        .view-log-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .view-log-btn:hover {
            background: linear-gradient(135deg, #42A5F5 0%, #2196F3 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .test-table .result-pass {
            color: #5cb85c;
            font-weight: 600;
        }

        .test-table .result-fail {
            color: #d9534f;
            font-weight: 600;
        }

        .test-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .test-table th {
            background-color: rgba(52, 73, 94, 0.95);
            color: #5cb85c;
            padding: 14px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 2px solid rgba(92, 184, 92, 0.3);
        }

        .test-table td {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #e8ecef;
        }

        .test-table tr:hover {
            background-color: rgba(92, 184, 92, 0.1);
        }

        .modal-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-right: 20px;
        }

        .sort-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 2px solid rgba(92, 184, 92, 0.3);
            background: rgba(52, 73, 94, 0.6);
            color: #e8ecef;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            border-color: #5cb85c;
            background: rgba(92, 184, 92, 0.2);
            color: #5cb85c;
        }

        .sort-btn.active {
            background: linear-gradient(135deg, #5cb85c 0%, #4caf50 100%);
            color: #ffffff;
            border-color: #5cb85c;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #5cb85c;
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>

    <script>
        // Chart.js storage for lab monitor reports
        let reportCharts = {};

        // Draw donut chart (copied from dashboard)
        function drawReportDonut(id, data, labels) {
            if (reportCharts[id]) reportCharts[id].destroy();

            const ctx = document.getElementById(id);
            if (!ctx) return; // Canvas not yet in DOM

            const total = data.reduce((a, b) => a + b, 0);
            const passedPercent = total > 0 ? ((data[0] / total) * 100).toFixed(1) : 0;

            reportCharts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#5cb85c', '#d9534f'],
                        borderWidth: 4,
                        borderColor: 'rgba(52, 73, 94, 0.8)',
                        hoverBackgroundColor: ['#4caf50', '#c9302c'],
                        hoverBorderColor: '#5cb85c',
                        hoverBorderWidth: 5
                    }]
                },
                options: {
                    cutout: '75%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#e8ecef',
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '600',
                                    family: 'Segoe UI'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 8,
                                boxHeight: 8
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(52, 73, 94, 0.95)',
                            titleColor: '#5cb85c',
                            bodyColor: '#e8ecef',
                            borderColor: 'rgba(92, 184, 92, 0.5)',
                            borderWidth: 2,
                            padding: 14,
                            displayColors: true,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13,
                                weight: '600'
                            },
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value + ' (' + percent + '%)';
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    beforeDraw: function (chart) {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;
                        ctx.restore();

                        const fontSize = (height / 100).toFixed(2);

                        // Draw percentage
                        ctx.font = "bold " + (fontSize * 18) + "px Segoe UI";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#5cb85c";

                        const text = passedPercent + "%";
                        const textX = Math.round((width - ctx.measureText(text).width) / 2);
                        const textY = height / 2 - (fontSize * 6);

                        ctx.fillText(text, textX, textY);

                        // Draw total count
                        ctx.font = "bold " + (fontSize * 9) + "px Segoe UI";
                        ctx.fillStyle = "#e8ecef";
                        const text2 = "Total: " + total;
                        const text2X = Math.round((width - ctx.measureText(text2).width) / 2);
                        const text2Y = height / 2 + (fontSize * 7);
                        ctx.fillText(text2, text2X, text2Y);

                        ctx.save();
                    }
                }]
            });
        }

        // Global state
        let config = { labs: [] };
        let statuses = {};
        let currentLabId = null;
        let currentPlatformId = null;
        let currentDutId = null;
        let editMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Register Chart.js datalabels plugin
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }

            loadConfig();
            // Poll for status updates every 5 seconds
            setInterval(loadStatuses, 5000);
            // Poll for testing status every 10 seconds
            setInterval(checkAllTestingStatus, 10000);
            // Check testing status immediately after 2 seconds
            setTimeout(checkAllTestingStatus, 2000);
        });

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/lab_monitor/config');
                const data = await response.json();
                config = data;
                await loadStatuses();
                renderLabs();
                showDetailTable();
            } catch (error) {
                console.error('Error loading config:', error);
                showNotification('Error loading configuration', true);
            }
        }

        // Load statuses
        async function loadStatuses() {
            try {
                const response = await fetch('/api/lab_monitor/status');
                const newStatuses = await response.json();

                // Set 'testing' flag based on status field
                // If status is "testing", then testing = true
                for (const dutId in newStatuses) {
                    newStatuses[dutId].testing = (newStatuses[dutId].status === 'testing');
                }

                statuses = newStatuses;
            } catch (error) {
                console.error('Error loading statuses:', error);
            }
        }

        // Testing status checking
        async function checkAllTestingStatus() {
            if (!config || !config.labs) return;

            for (const lab of config.labs) {
                for (const platform of lab.platforms || []) {
                    for (const dut of platform.duts || []) {
                        if (dut.ip_address && dut.ip_address.trim() !== '') {
                            checkDutTesting(dut.id);
                        }
                    }
                }
            }
        }

        async function checkDutTesting(dutId) {
            try {
                const response = await fetch(`/api/lab_monitor/dut/${dutId}/testing`);
                const result = await response.json();

                if (result.success) {
                    // Update status in memory
                    if (!statuses[dutId]) {
                        statuses[dutId] = {};
                    }
                    statuses[dutId].testing = result.testing;

                    // Update UI for this specific DUT card
                    const dutElement = document.querySelector(`[data-dut-id="${dutId}"]`);
                    if (dutElement) {
                        const statusDot = dutElement.querySelector('.dut-status');
                        if (statusDot) {
                            if (result.testing) {
                                statusDot.className = 'dut-status testing';
                                dutElement.title = dutElement.title.replace(' - Testing in progress', '') + ' - Testing in progress';
                            } else {
                                // Restore original status
                                const originalStatus = statuses[dutId].status || 'unknown';
                                statusDot.className = `dut-status ${originalStatus}`;
                                dutElement.title = dutElement.title.replace(' - Testing in progress', '');
                            }
                        }
                    }

                    // Update table row if currently viewing All DUT Details
                    updateTableRow(dutId);
                }
            } catch (error) {
                // Silent fail for testing check to avoid console spam
            }
        }

        // Render labs
        function renderLabs() {
            const container = document.getElementById('labContainer');

            if (!config.labs || config.labs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No labs configured. Click "Add Lab Group" to get started.</p></div>';
                return;
            }

            container.innerHTML = '';

            config.labs.forEach(lab => {
                const labElement = createLabElement(lab);
                container.appendChild(labElement);
            });

            // Initialize drag and drop
            initializeDragAndDrop();
        }

        // Create lab element
        function createLabElement(lab) {
            const labDiv = document.createElement('div');
            labDiv.className = 'lab-group';
            labDiv.setAttribute('data-lab-id', lab.id);

            labDiv.innerHTML = `
                <div class="lab-header">
                    <div class="lab-title">${escapeHtml(lab.name)}</div>
                    <div class="lab-actions">
                        <button class="action-btn" onclick="showAddPlatformModal('${lab.id}')">+ Platform</button>
                        <button class="action-btn" onclick="showEditLabModal('${lab.id}')">Edit</button>
                        <button class="action-btn delete" onclick="deleteLab('${lab.id}')">Delete</button>
                    </div>
                </div>
                <div class="platforms-container" data-lab-id="${lab.id}">
                    ${lab.platforms && lab.platforms.length > 0
                    ? lab.platforms.map(platform => createPlatformHTML(lab.id, platform)).join('')
                    : '<div class="empty-state" style="padding: 20px;">No platforms. Click "+ Platform" to add one.</div>'
                }
                </div>
            `;

            return labDiv;
        }

        // Create platform HTML
        function createPlatformHTML(labId, platform) {
            return `
                <div class="platform-group" data-platform-id="${platform.id}" data-lab-id="${labId}">
                    <div class="platform-header">
                        <div class="platform-title">${escapeHtml(platform.name)}</div>
                        <div class="lab-actions">
                            <button class="action-btn" onclick="showAddDutModal('${labId}', '${platform.id}')">+ DUT</button>
                            <button class="action-btn" onclick="showEditPlatformModal('${labId}', '${platform.id}')">Edit</button>
                            <button class="action-btn delete" onclick="deletePlatform('${labId}', '${platform.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="duts-container" data-platform-id="${platform.id}">
                        ${platform.duts && platform.duts.length > 0
                    ? platform.duts.map(dut => createDutHTML(dut)).join('')
                    : '<div class="empty-state" style="padding: 10px; font-size: 12px;">No DUTs</div>'
                }
                    </div>
                </div>
            `;
        }

        // Create DUT HTML
        function createDutHTML(dut) {
            const status = statuses[dut.id] || { status: 'unknown' };
            // Safely get config_type - handle both string and object cases
            const configType = typeof dut.config_type === 'string' ? dut.config_type : (dut.config_type?.value || dut.config_type?.name || 'Config A');
            const configClass = configType.toLowerCase().replace(/\s+/g, '-');
            const lastChecked = status.last_checked ? new Date(status.last_checked).toLocaleString() : 'Never';
            const version = status.version || 'unknown';
            const versionLabel = version !== 'unknown' ? `NUI ${version}` : 'No version';
            const hasNewReports = status.has_new_reports || false;
            const newReportsCount = status.new_reports_count || 0;
            const isTesting = status.testing || false;

            // Determine status class - testing takes precedence over online/offline
            let statusClass = status.status;
            if (isTesting) {
                statusClass = 'testing';
            }

            // Safely get IP address
            const ipAddress = typeof dut.ip_address === 'string' ? dut.ip_address : (dut.ip_address || 'No IP');

            return `
                <div class="dut-item ${hasNewReports ? 'has-new-report' : ''}" data-dut-id="${dut.id}" title="${escapeHtml(String(ipAddress))} - Last checked: ${lastChecked}${isTesting ? ' - Testing in progress' : ''}">
                    <div class="dut-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="2" y="4" width="20" height="16" rx="2" stroke="white" stroke-width="1.5" fill="none"/>
                            <circle cx="5" cy="8" r="0.8" fill="white"/>
                            <circle cx="7.5" cy="8" r="0.8" fill="white"/>
                            <circle cx="10" cy="8" r="0.8" fill="white"/>
                            <circle cx="12.5" cy="8" r="0.8" fill="white"/>
                            <circle cx="15" cy="8" r="0.8" fill="white"/>
                            <circle cx="17.5" cy="8" r="0.8" fill="white"/>
                            <circle cx="20" cy="8" r="0.8" fill="white"/>
                            <path d="M7 14 L10 14 M10 14 L9 13 M10 14 L9 15" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 14 L17 14 M14 14 L15 13 M14 14 L15 15" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7 17 L10 17 M10 17 L9 16 M10 17 L9 18" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 17 L17 17 M14 17 L15 16 M14 17 L15 18" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="dut-config ${configClass}"></div>
                    <div class="dut-info">
                        <span class="dut-name">${escapeHtml(String(dut.name || 'Unnamed DUT'))}</span>
                        <span class="dut-version">${versionLabel}</span>
                    </div>
                    ${hasNewReports ? `<div class="new-report-badge" title="Click to sync ${newReportsCount} new report(s)" onclick="showSyncModal('${dut.id}'); event.stopPropagation();">${newReportsCount}</div>` : ''}
                    <div class="dut-status ${statusClass}"></div>
                    <div class="dut-actions">
                        ${dut.ip_address ? `<button class="action-btn" onclick="showReportModal('${dut.id}'); event.stopPropagation();">Reports</button>` : ''}
                        ${hasNewReports ? `<button class="action-btn sync" onclick="showSyncModal('${dut.id}'); event.stopPropagation();">Sync All (${newReportsCount})</button>` : ''}
                        ${dut.ip_address ? `<button class="action-btn" onclick="checkDutVersion('${dut.id}'); event.stopPropagation();">Version</button>` : ''}
                        ${dut.ip_address ? `<button class="action-btn" onclick="checkDutStatus('${dut.id}'); event.stopPropagation();">Status</button>` : ''}
                        <button class="action-btn" onclick="showEditDutModal('${dut.id}'); event.stopPropagation();">Edit</button>
                        <button class="action-btn delete" onclick="deleteDut('${dut.id}'); event.stopPropagation();">Delete</button>
                    </div>
                </div>
            `;
        }

        // Initialize drag and drop
        function initializeDragAndDrop() {
            let isCtrlPressed = false;

            // Track Ctrl/Cmd key state
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    isCtrlPressed = true;
                    document.getElementById('copyHint').classList.add('show');
                }
            });

            document.addEventListener('keyup', (e) => {
                if (!e.ctrlKey && !e.metaKey) {
                    isCtrlPressed = false;
                    document.getElementById('copyHint').classList.remove('show');
                }
            });

            // Platform drag and drop within labs
            document.querySelectorAll('.platforms-container').forEach(container => {
                new Sortable(container, {
                    group: 'platforms',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onStart: function (evt) {
                        if (isCtrlPressed) {
                            evt.item.classList.add('copying');
                        }
                    },
                    onEnd: async function (evt) {
                        evt.item.classList.remove('copying');
                        const platformId = evt.item.getAttribute('data-platform-id');
                        const oldLabId = evt.from.getAttribute('data-lab-id');
                        const newLabId = evt.to.getAttribute('data-lab-id');

                        if (oldLabId !== newLabId) {
                            if (isCtrlPressed) {
                                await copyPlatform(oldLabId, newLabId, platformId);
                            } else {
                                await movePlatform(oldLabId, newLabId, platformId);
                            }
                        }
                    }
                });
            });

            // DUT drag and drop within platforms
            document.querySelectorAll('.duts-container').forEach(container => {
                new Sortable(container, {
                    group: 'duts',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onStart: function (evt) {
                        if (isCtrlPressed) {
                            evt.item.classList.add('copying');
                        }
                    },
                    onEnd: async function (evt) {
                        evt.item.classList.remove('copying');
                        const dutId = evt.item.getAttribute('data-dut-id');
                        const oldPlatformId = evt.from.getAttribute('data-platform-id');
                        const newPlatformId = evt.to.getAttribute('data-platform-id');

                        if (oldPlatformId !== newPlatformId) {
                            if (isCtrlPressed) {
                                await copyDut(oldPlatformId, newPlatformId, dutId);
                            } else {
                                await moveDut(oldPlatformId, newPlatformId, dutId);
                            }
                        }
                    }
                });
            });
        }

        // Lab Modal functions
        function showAddLabModal() {
            document.getElementById('labModalTitle').textContent = 'Add Lab Group';
            document.getElementById('labName').value = '';
            document.getElementById('labDescription').value = '';
            currentLabId = null;
            editMode = false;
            document.getElementById('labModal').classList.add('show');
        }

        function showEditLabModal(labId) {
            const lab = config.labs.find(l => l.id === labId);
            if (!lab) return;

            document.getElementById('labModalTitle').textContent = 'Edit Lab Group';
            document.getElementById('labName').value = lab.name;
            document.getElementById('labDescription').value = lab.description || '';
            currentLabId = labId;
            editMode = true;
            document.getElementById('labModal').classList.add('show');
        }

        function closeLabModal() {
            document.getElementById('labModal').classList.remove('show');
        }

        async function saveLabModal() {
            const name = document.getElementById('labName').value.trim();
            const description = document.getElementById('labDescription').value.trim();

            if (!name) {
                showNotification('Lab name is required', true);
                return;
            }

            try {
                let response;
                if (editMode && currentLabId) {
                    response = await fetch(`/api/lab_monitor/lab/${currentLabId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });
                } else {
                    response = await fetch('/api/lab_monitor/lab', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });
                }

                const result = await response.json();
                if (result.success) {
                    showNotification(editMode ? 'Lab updated successfully' : 'Lab added successfully');
                    closeLabModal();
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to save lab', true);
                }
            } catch (error) {
                console.error('Error saving lab:', error);
                showNotification('Error saving lab', true);
            }
        }

        async function deleteLab(labId) {
            if (!confirm('Are you sure you want to delete this lab and all its platforms?')) {
                return;
            }

            try {
                const response = await fetch(`/api/lab_monitor/lab/${labId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Lab deleted successfully');
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to delete lab', true);
                }
            } catch (error) {
                console.error('Error deleting lab:', error);
                showNotification('Error deleting lab', true);
            }
        }

        // Platform Modal functions
        function showAddPlatformModal(labId) {
            document.getElementById('platformModalTitle').textContent = 'Add Platform Group';
            document.getElementById('platformName').value = '';
            document.getElementById('platformDescription').value = '';
            currentLabId = labId;
            currentPlatformId = null;
            editMode = false;
            document.getElementById('platformModal').classList.add('show');
        }

        function showEditPlatformModal(labId, platformId) {
            const lab = config.labs.find(l => l.id === labId);
            if (!lab) return;

            const platform = lab.platforms.find(p => p.id === platformId);
            if (!platform) return;

            document.getElementById('platformModalTitle').textContent = 'Edit Platform Group';
            document.getElementById('platformName').value = platform.name;
            document.getElementById('platformDescription').value = platform.description || '';
            currentLabId = labId;
            currentPlatformId = platformId;
            editMode = true;
            document.getElementById('platformModal').classList.add('show');
        }

        function closePlatformModal() {
            document.getElementById('platformModal').classList.remove('show');
        }

        async function savePlatformModal() {
            const name = document.getElementById('platformName').value.trim();
            const description = document.getElementById('platformDescription').value.trim();

            if (!name) {
                showNotification('Platform name is required', true);
                return;
            }

            try {
                let response;
                if (editMode && currentPlatformId) {
                    response = await fetch(`/api/lab_monitor/platform/${currentLabId}/${currentPlatformId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });
                } else {
                    response = await fetch('/api/lab_monitor/platform', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lab_id: currentLabId, name, description })
                    });
                }

                const result = await response.json();
                if (result.success) {
                    showNotification(editMode ? 'Platform updated successfully' : 'Platform added successfully');
                    closePlatformModal();
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to save platform', true);
                }
            } catch (error) {
                console.error('Error saving platform:', error);
                showNotification('Error saving platform', true);
            }
        }

        async function deletePlatform(labId, platformId) {
            if (!confirm('Are you sure you want to delete this platform and all its DUTs?')) {
                return;
            }

            try {
                const response = await fetch(`/api/lab_monitor/platform/${labId}/${platformId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Platform deleted successfully');
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to delete platform', true);
                }
            } catch (error) {
                console.error('Error deleting platform:', error);
                showNotification('Error deleting platform', true);
            }
        }

        async function movePlatform(sourceLabId, targetLabId, platformId) {
            try {
                const response = await fetch('/api/lab_monitor/platform/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_lab_id: sourceLabId,
                        target_lab_id: targetLabId,
                        platform_id: platformId
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Platform moved successfully');
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to move platform', true);
                    await loadConfig(); // Reload to reset positions
                }
            } catch (error) {
                console.error('Error moving platform:', error);
                showNotification('Error moving platform', true);
                await loadConfig();
            }
        }

        async function copyPlatform(sourceLabId, targetLabId, platformId) {
            try {
                const response = await fetch('/api/lab_monitor/platform/copy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_lab_id: sourceLabId,
                        target_lab_id: targetLabId,
                        platform_id: platformId
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Platform copied successfully');
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to copy platform', true);
                    await loadConfig();
                }
            } catch (error) {
                console.error('Error copying platform:', error);
                showNotification('Error copying platform', true);
                await loadConfig();
            }
        }

        // DUT Modal functions
        function showAddDutModal(labId, platformId) {
            document.getElementById('dutModalTitle').textContent = 'Add DUT';
            document.getElementById('dutName').value = '';
            document.getElementById('dutIp').value = '';
            document.getElementById('dutPassword').value = '';
            document.getElementById('dutConfig').value = 'Config A';
            document.getElementById('dutDescription').value = '';
            currentLabId = labId;
            currentPlatformId = platformId;
            currentDutId = null;
            editMode = false;
            document.getElementById('dutModal').classList.add('show');
        }

        function showEditDutModal(dutId) {
            // Find the DUT
            let foundDut = null;
            let foundLabId = null;
            let foundPlatformId = null;

            for (const lab of config.labs) {
                for (const platform of lab.platforms) {
                    const dut = platform.duts.find(d => d.id === dutId);
                    if (dut) {
                        foundDut = dut;
                        foundLabId = lab.id;
                        foundPlatformId = platform.id;
                        break;
                    }
                }
                if (foundDut) break;
            }

            if (!foundDut) return;

            document.getElementById('dutModalTitle').textContent = 'Edit DUT';
            document.getElementById('dutName').value = foundDut.name;
            document.getElementById('dutIp').value = foundDut.ip_address || '';
            document.getElementById('dutPassword').value = foundDut.password || '';
            // Safely get config_type - handle both string and object cases
            const configTypeValue = typeof foundDut.config_type === 'string' ? foundDut.config_type : (foundDut.config_type?.value || foundDut.config_type?.name || 'Config A');
            document.getElementById('dutConfig').value = configTypeValue;
            document.getElementById('dutDescription').value = foundDut.description || '';
            currentLabId = foundLabId;
            currentPlatformId = foundPlatformId;
            currentDutId = dutId;
            editMode = true;
            document.getElementById('dutModal').classList.add('show');
        }

        function closeDutModal() {
            document.getElementById('dutModal').classList.remove('show');
        }

        async function saveDutModal() {
            const name = document.getElementById('dutName').value.trim();
            const ip_address = document.getElementById('dutIp').value.trim();
            const password = document.getElementById('dutPassword').value;
            const config_type = document.getElementById('dutConfig').value;
            const description = document.getElementById('dutDescription').value.trim();

            if (!name) {
                showNotification('DUT name is required', true);
                return;
            }

            try {
                let response;
                if (editMode && currentDutId) {
                    response = await fetch(`/api/lab_monitor/dut/${currentLabId}/${currentPlatformId}/${currentDutId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, ip_address, password, config_type, description })
                    });
                } else {
                    response = await fetch('/api/lab_monitor/dut', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lab_id: currentLabId,
                            platform_id: currentPlatformId,
                            name,
                            ip_address,
                            password,
                            config_type,
                            description
                        })
                    });
                }

                const result = await response.json();
                if (result.success) {
                    showNotification(editMode ? 'DUT updated successfully' : 'DUT added successfully');
                    closeDutModal();
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to save DUT', true);
                }
            } catch (error) {
                console.error('Error saving DUT:', error);
                showNotification('Error saving DUT', true);
            }
        }

        async function deleteDut(dutId) {
            if (!confirm('Are you sure you want to delete this DUT?')) {
                return;
            }

            // Find the DUT's lab and platform
            let labId = null;
            let platformId = null;

            for (const lab of config.labs) {
                for (const platform of lab.platforms) {
                    if (platform.duts.some(d => d.id === dutId)) {
                        labId = lab.id;
                        platformId = platform.id;
                        break;
                    }
                }
                if (labId) break;
            }

            if (!labId || !platformId) {
                showNotification('DUT not found', true);
                return;
            }

            try {
                const response = await fetch(`/api/lab_monitor/dut/${labId}/${platformId}/${dutId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('DUT deleted successfully');
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to delete DUT', true);
                }
            } catch (error) {
                console.error('Error deleting DUT:', error);
                showNotification('Error deleting DUT', true);
            }
        }

        async function moveDut(sourcePlatformId, targetPlatformId, dutId) {
            try {
                const response = await fetch('/api/lab_monitor/dut/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_platform_id: sourcePlatformId,
                        target_platform_id: targetPlatformId,
                        dut_id: dutId
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('DUT moved successfully');
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to move DUT', true);
                    await loadConfig(); // Reload to reset positions
                }
            } catch (error) {
                console.error('Error moving DUT:', error);
                showNotification('Error moving DUT', true);
                await loadConfig();
            }
        }

        async function copyDut(sourcePlatformId, targetPlatformId, dutId) {
            try {
                const response = await fetch('/api/lab_monitor/dut/copy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_platform_id: sourcePlatformId,
                        target_platform_id: targetPlatformId,
                        dut_id: dutId
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('DUT copied successfully');
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to copy DUT', true);
                    await loadConfig();
                }
            } catch (error) {
                console.error('Error copying DUT:', error);
                showNotification('Error copying DUT', true);
                await loadConfig();
            }
        }

        // Utility functions
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show' + (isError ? ' error' : '');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showConfigMenu() {
            // For now, just show a simple alert
            // This can be expanded to show a more detailed config menu
            alert('Configuration menu coming soon!\n\nYou can currently:\n- Add/Edit/Delete Labs\n- Add/Edit/Delete Platforms\n- Add/Edit/Delete DUTs\n- Drag and drop to reorganize');
        }

        // Combined check function
        async function checkAllInOne() {
            try {
                showNotification('Step 1/3: Checking all DUT statuses...');

                // Step 1: Check all statuses
                const statusResponse = await fetch('/api/lab_monitor/status/check_all', {
                    method: 'POST'
                });
                const statusResult = await statusResponse.json();

                if (statusResult.success) {
                    showNotification(`Step 1/3: Status check complete: ${statusResult.online_count} online, ${statusResult.offline_count} offline`);
                } else {
                    showNotification('Step 1/3: Status check failed', true);
                }

                // Step 2: Check all versions
                showNotification('Step 2/3: Checking all DUT versions...');
                const versionResponse = await fetch('/api/lab_monitor/versions/check_all', {
                    method: 'POST'
                });
                const versionResult = await versionResponse.json();

                if (versionResult.success) {
                    showNotification(`Step 2/3: Version check complete: ${versionResult.success_count} success, ${versionResult.failed_count} failed`);
                } else {
                    showNotification('Step 2/3: Version check failed', true);
                }

                // Step 3: Check all reports
                showDebugWindow();
                addDebugLog('Step 3/3: Starting report check for all DUTs...', 'info');
                showNotification('Step 3/3: Checking all DUT reports...');

                const reportResponse = await fetch('/api/lab_monitor/reports/check_all', {
                    method: 'POST'
                });
                const reportResult = await reportResponse.json();

                if (reportResult.success) {
                    addDebugLog(`Report check complete: ${reportResult.has_new_count} DUTs with new reports`, 'success');

                    // Log detailed results if available
                    if (reportResult.logs && Array.isArray(reportResult.logs)) {
                        reportResult.logs.forEach(log => {
                            addDebugLog(log.message, log.type || 'info');
                        });
                    }

                    showNotification(`‚úÖ All checks complete! ${reportResult.has_new_count} DUTs have new reports to sync.`);
                } else {
                    showNotification('Step 3/3: Report check failed', true);
                }

                // Reload config to show updated status
                await loadConfig();

            } catch (error) {
                console.error('Error in checkAllInOne:', error);
                showNotification('Error during check operation', true);
            }
        }

        // Status checking functions
        async function checkAllStatus() {
            try {
                showNotification('Checking all DUT statuses...');
                const response = await fetch('/api/lab_monitor/status/check_all', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(`Status check complete: ${result.online_count} online, ${result.offline_count} offline, ${result.skipped_count} skipped`);
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to check status', true);
                }
            } catch (error) {
                console.error('Error checking status:', error);
                showNotification('Error checking status', true);
            }
        }

        async function checkDutStatus(dutId) {
            try {
                const response = await fetch(`/api/lab_monitor/dut/${dutId}/check`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(`${result.dut_id}: ${result.status}`);
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to check DUT status', true);
                }
            } catch (error) {
                console.error('Error checking DUT status:', error);
                showNotification('Error checking DUT status', true);
            }
        }

        async function checkDutVersion(dutId) {
            try {
                showNotification('Checking DUT version...');
                const response = await fetch(`/api/lab_monitor/dut/${dutId}/version`);
                const result = await response.json();

                if (result.success) {
                    showNotification(`${result.dut_id}: ${result.version}`);
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to get DUT version', true);
                }
            } catch (error) {
                console.error('Error checking DUT version:', error);
                showNotification('Error checking DUT version', true);
            }
        }

        async function checkAllVersions() {
            try {
                showNotification('Checking all DUT versions...');
                const response = await fetch('/api/lab_monitor/versions/check_all', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(`Version check complete: ${result.success_count} success, ${result.failed_count} failed, ${result.skipped_count} skipped`);
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to check versions', true);
                }
            } catch (error) {
                console.error('Error checking versions:', error);
                showNotification('Error checking versions', true);
            }
        }

        async function updateStatusCheckerInfo() {
            try {
                const response = await fetch('/api/lab_monitor/status/checker');
                const info = await response.json();

                const infoElement = document.getElementById('statusCheckerInfo');
                if (info.running) {
                    const nextCheck = Math.max(0, info.next_check_in);
                    infoElement.textContent = `Background checker: Running (next check in ${nextCheck}s)`;
                } else {
                    infoElement.textContent = 'Background checker: Stopped';
                }
            } catch (error) {
                console.error('Error getting checker info:', error);
            }
        }

        // Report sync functions
        async function checkAllReports() {
            try {
                // Open debug window
                showDebugWindow();
                addDebugLog('Starting report check for all DUTs...', 'info');

                showNotification('Checking all DUT reports...');
                const response = await fetch('/api/lab_monitor/reports/check_all', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    addDebugLog(`Report check complete: ${result.has_new_count} DUTs with new reports`, 'success');

                    // Log detailed results if available
                    if (result.logs && Array.isArray(result.logs)) {
                        result.logs.forEach(log => {
                            addDebugLog(log.message, log.type || 'info');
                        });
                    }

                    showNotification(`Report check complete: ${result.has_new_count} DUTs with new reports`);
                    await loadConfig();
                } else {
                    addDebugLog(`Error: ${result.error || 'Failed to check reports'}`, 'error');
                    showNotification(result.error || 'Failed to check reports', true);
                }
            } catch (error) {
                console.error('Error checking reports:', error);
                addDebugLog(`Exception: ${error.message}`, 'error');
                showNotification('Error checking reports', true);
            }
        }

        async function checkDutReports(dutId) {
            try {
                showNotification('Checking DUT reports...');
                const response = await fetch(`/api/lab_monitor/dut/${dutId}/reports/check`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    if (result.has_new_reports) {
                        showNotification(`Found ${result.new_reports.length} new report(s)`);
                    } else {
                        showNotification('No new reports found');
                    }
                    await loadConfig();
                } else {
                    showNotification(result.error || 'Failed to check reports', true);
                }
            } catch (error) {
                console.error('Error checking DUT reports:', error);
                showNotification('Error checking DUT reports', true);
            }
        }

        let currentSyncTaskId = null;
        let syncPollingInterval = null;
        let syncQueue = [];
        let currentSyncDutId = null;
        let totalReportsCount = 0;  // Track total count

        async function showSyncModal(dutId) {
            // Get DUT info and new reports
            const response = await fetch(`/api/lab_monitor/dut/${dutId}/reports/check`, {
                method: 'POST'
            });
            const result = await response.json();

            if (!result.success || !result.has_new_reports) {
                showNotification('No new reports to sync', true);
                return;
            }

            // Sync all new reports
            syncQueue = result.new_reports.map(r => r.date);
            currentSyncDutId = dutId;
            totalReportsCount = syncQueue.length;  // Save total count

            document.getElementById('syncModalTitle').textContent = `Syncing ${syncQueue.length} Reports`;
            document.getElementById('syncModal').classList.add('show');
            document.getElementById('syncCloseBtn').disabled = true;

            // Start syncing first report
            syncNextReport();
        }

        async function syncNextReport() {
            if (syncQueue.length === 0) {
                // All done!
                document.getElementById('syncMessage').textContent = 'All reports synced successfully!';
                document.getElementById('syncProgressBar').style.width = '100%';
                document.getElementById('syncProgressText').textContent = '100%';
                document.getElementById('syncCloseBtn').disabled = false;

                // Reload config to update UI
                await loadConfig();

                showNotification('All reports synced successfully!');

                // Auto-close modal after 2 seconds
                setTimeout(() => {
                    closeSyncModal();
                }, 2000);

                return;
            }

            const reportDate = syncQueue[0];
            const currentIndex = totalReportsCount - syncQueue.length + 1;

            document.getElementById('syncMessage').textContent = `Syncing report ${currentIndex}/${totalReportsCount}: ${reportDate}`;

            // Start sync
            try {
                const syncResponse = await fetch(`/api/lab_monitor/dut/${currentSyncDutId}/reports/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: reportDate })
                });
                const syncResult = await syncResponse.json();

                if (syncResult.success) {
                    currentSyncTaskId = syncResult.task_id;
                    // Start polling for progress
                    pollSyncProgress();
                } else {
                    showNotification(syncResult.error || 'Failed to start sync', true);
                    closeSyncModal();
                }
            } catch (error) {
                console.error('Error starting sync:', error);
                showNotification('Error starting sync', true);
                closeSyncModal();
            }
        }

        async function pollSyncProgress() {
            if (!currentSyncTaskId) return;

            try {
                const response = await fetch(`/api/lab_monitor/sync/status/${currentSyncTaskId}`);
                const status = await response.json();

                if (status.success) {
                    // Update progress bar
                    const progress = status.progress || 0;
                    document.getElementById('syncProgressBar').style.width = progress + '%';
                    document.getElementById('syncProgressText').textContent = progress + '%';
                    document.getElementById('syncMessage').textContent = status.message || 'Processing...';

                    if (status.status === 'completed') {
                        // Remove completed report from queue
                        syncQueue.shift();

                        if (syncPollingInterval) {
                            clearInterval(syncPollingInterval);
                            syncPollingInterval = null;
                        }

                        // Continue with next report
                        if (syncQueue.length > 0) {
                            setTimeout(() => syncNextReport(), 500);
                        } else {
                            showNotification('All reports synced successfully!');
                            document.getElementById('syncMessage').textContent = 'All reports synced successfully!';
                            document.getElementById('syncCloseBtn').disabled = false;
                            await loadConfig();

                            // Auto-close modal after 2 seconds
                            setTimeout(() => {
                                closeSyncModal();
                            }, 2000);
                        }
                        return;
                    } else if (status.status === 'failed') {
                        showNotification(status.error || 'Sync failed', true);
                        document.getElementById('syncCloseBtn').disabled = false;
                        if (syncPollingInterval) {
                            clearInterval(syncPollingInterval);
                            syncPollingInterval = null;
                        }
                    } else {
                        // Continue polling
                        if (!syncPollingInterval) {
                            syncPollingInterval = setInterval(pollSyncProgress, 1000);
                        }
                    }
                }
            } catch (error) {
                console.error('Error polling sync progress:', error);
            }
        }

        function closeSyncModal() {
            document.getElementById('syncModal').classList.remove('show');
            if (syncPollingInterval) {
                clearInterval(syncPollingInterval);
                syncPollingInterval = null;
            }
            currentSyncTaskId = null;
            // Reset progress
            document.getElementById('syncProgressBar').style.width = '0%';
            document.getElementById('syncProgressText').textContent = '0%';
            document.getElementById('syncMessage').textContent = 'Preparing...';
        }

        // Debug Window Functions
        function showDebugWindow() {
            const debugWindow = document.getElementById('debugWindow');
            debugWindow.style.display = 'flex';
        }

        function closeDebugWindow() {
            const debugWindow = document.getElementById('debugWindow');
            debugWindow.style.display = 'none';
        }

        function addDebugLog(message, type = 'info') {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = `debug-log-entry ${type}`;
            logEntry.innerHTML = `<span class="debug-log-timestamp">[${timestamp}]</span>${message}`;

            debugContent.appendChild(logEntry);
            debugContent.scrollTop = debugContent.scrollHeight;
        }

        function clearDebugLog() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = '';
            addDebugLog('Debug log cleared', 'info');
        }

        // Update checker info every 5 seconds
        setInterval(updateStatusCheckerInfo, 5000);
        updateStatusCheckerInfo();

        // Load and display version
        function loadVersion() {
            fetch('/VERSION')
                .then(response => response.text())
                .then(version => {
                    const versionDisplay = document.getElementById('versionDisplay');
                    if (versionDisplay) {
                        versionDisplay.textContent = version.trim();
                    }
                })
                .catch(err => {
                    console.log('Failed to load version:', err);
                });
        }

        // Load version on page load
        loadVersion();

        // Update a specific DUT's row in the table without full re-render
        function updateTableRow(dutId) {
            const tbody = document.getElementById('detailTableBody');
            if (!tbody) return;

            // Find the row with matching data-dut-id attribute
            const row = tbody.querySelector(`tr[data-dut-id="${dutId}"]`);
            if (!row) {
                console.log(`[updateTableRow] No row found for dutId: ${dutId}`);
                return;
            }

            // Update the "Under Testing" column (8th column, index 7)
            const testingCell = row.cells[7];
            if (testingCell) {
                const status = statuses[dutId] || {};
                const isTesting = status.testing || false;
                console.log(`[updateTableRow] Updating dutId ${dutId}: testing=${isTesting}`);
                testingCell.innerHTML = `
                    <span class="table-status-badge ${isTesting ? 'testing' : ''}" style="${!isTesting ? 'opacity: 0.3;' : ''}">
                        ${isTesting ? 'YES' : 'NO'}
                    </span>
                `;
            }
        }

        // Detail Table Functions
        function showDetailTable(labId = null, platformId = null) {
            const container = document.getElementById('detailTableContainer');
            const tbody = document.getElementById('detailTableBody');
            const titleElement = document.getElementById('detailTableTitle');

            tbody.innerHTML = '';

            // Find data to display
            let duts = [];
            let title = 'All DUT Details';

            if (labId && platformId) {
                // Show specific platform's DUTs
                const lab = config.labs.find(l => l.id === labId);
                if (lab) {
                    const platform = lab.platforms.find(p => p.id === platformId);
                    if (platform) {
                        platform.duts.forEach(dut => {
                            duts.push({ ...dut, labName: lab.name, platformName: platform.name });
                        });
                        title = `${lab.name} / ${platform.name} - DUT Details`;
                    }
                }
            } else if (labId) {
                // Show all DUTs in a lab
                const lab = config.labs.find(l => l.id === labId);
                if (lab) {
                    lab.platforms.forEach(platform => {
                        platform.duts.forEach(dut => {
                            duts.push({ ...dut, labName: lab.name, platformName: platform.name });
                        });
                    });
                    title = `${lab.name} - All DUT Details`;
                }
            } else {
                // Show all DUTs
                config.labs.forEach(lab => {
                    lab.platforms.forEach(platform => {
                        platform.duts.forEach(dut => {
                            duts.push({ ...dut, labName: lab.name, platformName: platform.name });
                        });
                    });
                });
            }

            titleElement.textContent = title;

            // Populate table
            duts.forEach(dut => {
                const status = statuses[dut.id] || {};
                const version = status.version || 'N/A';
                const onlineStatus = status.status || 'offline';
                const isTesting = status.testing || false;
                const newReportsCount = status.new_reports_count || 0;
                const hasNewReports = newReportsCount > 0;

                const row = document.createElement('tr');
                row.setAttribute('data-dut-id', dut.id); // Add dut ID for easy lookup
                row.innerHTML = `
                    <td>${escapeHtml(dut.labName || 'N/A')}</td>
                    <td>${escapeHtml(dut.platformName || 'N/A')}</td>
                    <td><strong>${escapeHtml(dut.name)}</strong></td>
                    <td>${escapeHtml(version)}</td>
                    <td>${escapeHtml(dut.ip_address || 'N/A')}</td>
                    <td>
                        ${hasNewReports ?
                        `<span class="table-new-report" onclick="showSyncModal('${dut.id}'); event.stopPropagation();" title="Click to sync ${newReportsCount} new report(s)">
                                <span class="table-new-report-badge">${newReportsCount}</span>
                                New
                            </span>` :
                        '<span style="color: #95a5a6;">-</span>'
                    }
                    </td>
                    <td>
                        <span class="table-status-badge ${onlineStatus}">
                            ${onlineStatus.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <span class="table-status-badge ${isTesting ? 'testing' : ''}" style="${!isTesting ? 'opacity: 0.3;' : ''}">
                            ${isTesting ? 'YES' : 'NO'}
                        </span>
                    </td>
                    <td>
                        <button class="table-btn" onclick="showReportModal('${dut.id}'); event.stopPropagation();">Report</button>
                    </td>
                    <td>
                        <button class="table-btn secondary" onclick="event.stopPropagation();">Schedule</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (duts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="10" style="text-align: center; color: #95a5a6; padding: 30px;">No DUTs found</td>';
                tbody.appendChild(row);
            }

        }

        // =====================================================================
        // Report Dashboard Modal Functions
        // =====================================================================

        let currentReportDutId = null;
        let reportAvailableDates = [];
        let reportCurrentMonth = new Date().getMonth();
        let reportCurrentYear = new Date().getFullYear();
        let reportCurrentSummary = null;
        let reportCurrentTestItems = [];
        let reportCurrentCategory = null;
        let reportCurrentLevel = null;
        let reportCurrentSortFilter = 'all';
        let reportCurrentDutId = '';
        let reportCurrentDate = '';
        let reportCurrentPlatform = '';
        // Always define these globals to avoid ReferenceError
        window.reportCurrentLabName = '';
        window.reportCurrentDutName = '';

        // Trend-related global variables
        let reportTrendChart = null;
        let reportCurrentTrendType = null; // 'all' or 'case'
        let reportCurrentTrendCategory = null;
        let reportCurrentTrendLevel = null;
        let reportCurrentTrendRange = 'week'; // 'week', 'month', or 'year'
        let reportCurrentTrendData = null;

        function showReportModal(dutId) {
            currentReportDutId = dutId;
            const modal = document.getElementById('reportDashboardModal');

            // Find DUT information
            let dutInfo = null;
            for (const lab of config.labs) {
                for (const platform of lab.platforms) {
                    for (const dut of platform.duts) {
                        if (dut.id === dutId) {
                            dutInfo = { dut, platform, lab };
                            break;
                        }
                    }
                    if (dutInfo) break;
                }
                if (dutInfo) break;
            }

            if (!dutInfo) {
                alert('DUT not found');
                return;
            }

            // Update modal title and platform display
            document.getElementById('reportModalTitle').textContent = `Test Report Dashboard`;
            document.getElementById('reportPlatformDisplay').textContent = `${dutInfo.lab.name} / ${dutInfo.platform.name} / ${dutInfo.dut.name}`;

            // Load available dates
            loadReportDates(dutId);

            modal.style.display = 'block';
        }

        function closeReportModal() {
            document.getElementById('reportDashboardModal').style.display = 'none';
            document.getElementById('reportCalendarPopup').style.display = 'none';
            currentReportDutId = null;
        }

        async function loadReportDates(dutId) {
            const input = document.getElementById('reportDateInput');
            input.value = 'Loading...';

            try {
                const response = await fetch(`/api/lab_monitor/dut/${dutId}/dashboard/dates`);
                const data = await response.json();

                if (data.success && data.dates && data.dates.length > 0) {
                    reportAvailableDates = data.dates;
                    // Set most recent date
                    const latestDate = data.dates[0];
                    document.getElementById('reportDateInput').value = latestDate;

                    // Set calendar to the month of latest date
                    const dateObj = new Date(latestDate);
                    reportCurrentMonth = dateObj.getMonth();
                    reportCurrentYear = dateObj.getFullYear();

                    // Load the dashboard
                    loadReportDashboard(latestDate);
                } else {
                    input.value = 'No reports found';
                    document.getElementById('reportDashboardContent').innerHTML =
                        '<div class="report-card" style="text-align: center; padding: 60px;"><h2 style="color: #95a5a6;">No test reports found for this DUT</h2><p style="color: #7f8c8d;">Reports will appear here after tests are synced from the DUT.</p></div>';
                }
            } catch (error) {
                console.error('Error loading report dates:', error);
                input.value = 'Error';
                document.getElementById('reportDashboardContent').innerHTML =
                    `<div class="report-card" style="text-align: center; padding: 60px;"><h2 style="color: #e74c3c;">Error Loading Dates</h2><p style="color: #c0392b;">${error.message}</p></div>`;
            }
        }

        function toggleReportCalendar() {
            const popup = document.getElementById('reportCalendarPopup');
            if (popup.style.display === 'none' || !popup.style.display) {
                popup.style.display = 'block';
                renderReportCalendar();
            } else {
                popup.style.display = 'none';
            }
        }

        function renderReportCalendar() {
            const monthYearDisplay = document.getElementById('reportCurrentMonthYear');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearDisplay.textContent = `${monthNames[reportCurrentMonth]} ${reportCurrentYear}`;

            const calendarGrid = document.getElementById('reportCalendarGrid');

            // Remove existing day cells (keep weekday headers)
            const existingDays = calendarGrid.querySelectorAll('.calendar-day, .empty');
            existingDays.forEach(day => day.remove());

            const firstDay = new Date(reportCurrentYear, reportCurrentMonth, 1).getDay();
            const daysInMonth = new Date(reportCurrentYear, reportCurrentMonth + 1, 0).getDate();

            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                emptyDay.style.cssText = 'background: transparent; cursor: default;';
                calendarGrid.appendChild(emptyDay);
            }

            // Days of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${reportCurrentYear}-${String(reportCurrentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayElem = document.createElement('div');
                dayElem.className = 'calendar-day';
                dayElem.textContent = day;
                dayElem.style.cssText = 'aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; background: rgba(255, 255, 255, 0.05); color: #ecf0f1;';

                const isAvailable = reportAvailableDates.includes(dateStr);
                const isToday = (day === today.getDate() && reportCurrentMonth === today.getMonth() && reportCurrentYear === today.getFullYear());
                const isSelected = dateStr === document.getElementById('reportDateInput').value;

                if (isAvailable) {
                    dayElem.classList.add('available');
                    dayElem.style.background = 'rgba(92, 184, 92, 0.2)';
                    dayElem.style.border = '1px solid #5cb85c';
                    dayElem.style.fontWeight = 'bold';
                    dayElem.onclick = () => selectReportDate(dateStr);
                    dayElem.onmouseover = () => {
                        if (!isSelected) {
                            dayElem.style.background = 'rgba(92, 184, 92, 0.4)';
                            dayElem.style.boxShadow = '0 0 12px rgba(92, 184, 92, 0.6)';
                        }
                    };
                    dayElem.onmouseout = () => {
                        if (!isSelected) {
                            dayElem.style.background = 'rgba(92, 184, 92, 0.2)';
                            dayElem.style.boxShadow = 'none';
                        }
                    };
                } else {
                    dayElem.classList.add('disabled');
                    dayElem.style.color = '#555';
                    dayElem.style.cursor = 'not-allowed';
                    dayElem.style.background = 'rgba(0, 0, 0, 0.2)';
                }

                if (isToday) {
                    dayElem.style.border = '2px solid #2196F3';
                }

                if (isSelected) {
                    dayElem.style.background = '#5cb85c';
                    dayElem.style.color = 'white';
                    dayElem.style.fontWeight = 'bold';
                    dayElem.style.boxShadow = '0 0 15px rgba(92, 184, 92, 0.8)';
                }

                calendarGrid.appendChild(dayElem);
            }
        }

        function reportPreviousMonth() {
            reportCurrentMonth--;
            if (reportCurrentMonth < 0) {
                reportCurrentMonth = 11;
                reportCurrentYear--;
            }
            renderReportCalendar();
        }

        function reportNextMonth() {
            reportCurrentMonth++;
            if (reportCurrentMonth > 11) {
                reportCurrentMonth = 0;
                reportCurrentYear++;
            }
            renderReportCalendar();
        }

        function selectReportDate(dateStr) {
            document.getElementById('reportDateInput').value = dateStr;
            document.getElementById('reportCalendarPopup').style.display = 'none';
            loadReportDashboard(dateStr);
        }

        async function loadReportDashboard(selectedDate) {
            if (!selectedDate) {
                selectedDate = document.getElementById('reportDateInput').value;
            }

            if (!selectedDate || !currentReportDutId) {
                return;
            }

            const indicator = document.getElementById('reportLoadingIndicator');
            const content = document.getElementById('reportDashboardContent');

            indicator.style.display = 'inline';
            content.innerHTML = '<div class="report-card" style="text-align: center; padding: 60px;"><h2 style="color: #3498db;">Loading dashboard...</h2></div>';

            try {
                const response = await fetch(`/api/lab_monitor/dut/${currentReportDutId}/dashboard/summary/${selectedDate}`);
                const data = await response.json();

                if (data.success && data.summary) {
                    reportCurrentSummary = data.summary;
                    reportCurrentDutId = currentReportDutId;
                    reportCurrentDate = selectedDate;
                    reportCurrentPlatform = data.summary.platform_name || '';
                    // Set lab name for log detail API
                    window.reportCurrentLabName = data.summary.lab_name || '';
                    window.reportCurrentDutName = data.summary.dut_name || '';
                    renderReportDashboard(data.summary);
                } else {
                    content.innerHTML =
                        `<div class="report-card" style="text-align: center; padding: 60px;"><h2 style="color: #e74c3c;">Error Loading Report</h2><p style="color: #c0392b;">${data.error || 'Unknown error'}</p></div>`;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                content.innerHTML =
                    `<div class="report-card" style="text-align: center; padding: 60px;"><h2 style="color: #e74c3c;">Error Loading Report</h2><p style="color: #c0392b;">${error.message}</p></div>`;
            } finally {
                indicator.style.display = 'none';
            }
        }

        function renderReportDashboard(summary) {
            const content = document.getElementById('reportDashboardContent');

            // Build HTML with complete dashboard layout
            let html = '';

            // Version Info Card
            html += `
                <div class="report-card">
                    <h2>Version Info</h2>
                    <table class="report-version-table">
                        <tr>
                            <td>LAB</td>
                            <td>${summary.lab_name || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>PLATFORM</td>
                            <td>${summary.platform_name || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>DUT (Serial Number)</td>
                            <td>${summary.dut_name || 'N/A'}</td>
                        </tr>
            `;

            if (summary.version_info) {
                for (const [key, value] of Object.entries(summary.version_info)) {
                    html += `
                        <tr>
                            <td>${key}</td>
                            <td style="word-break: break-all;">${value}</td>
                        </tr>
                    `;
                }
            }

            html += `
                    </table>
                </div>
            `;

            // Total Test Cycle Status
            if (summary.all_tests && summary.all_tests.total > 0) {
                const duration = summary.all_tests.duration || '';
                const chartId = 'labMonitor-totalChart-' + Date.now();

                html += `
                    <div class="report-card clickable" style="cursor: pointer; position: relative;" onclick="showReportAllTestDetails()">
                        <button class="download-report-btn" onclick="event.stopPropagation(); downloadReportOrganizedReport()" 
                            id="downloadReportOrganizedBtn"
                            style="position: absolute; top: 15px; right: 15px; padding: 8px 16px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3); z-index: 10;"
                            title="Download organized test report (structured by test level, category, and topology)">üì¶ G report</button>
                        <button class="trend-btn" onclick="event.stopPropagation(); showReportTrend('all', 'all', 'Total Test Cycle Status')" 
                            style="position: absolute; top: 15px; right: 130px; padding: 8px 16px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3); z-index: 10;">üìà Trend</button>
                        <h3 style="text-align: center; font-size: 20px; font-weight: 600; color: #e8ecef; margin: 0 0 20px 0;">Total Test Cycle Status ${duration ? `<span style="color: #5cb85c; font-size: 16px; margin-left: 15px;">${duration}</span>` : ''}</h3>
                        <div class="chart-container">
                            <canvas id="${chartId}"></canvas>
                        </div>
                    </div>
                `;

                // Defer chart drawing to after DOM update
                setTimeout(() => {
                    drawReportDonut(chartId, [summary.all_tests.passed, summary.all_tests.failed], ['Passed', 'Failed']);
                }, 10);
            }

            // Helper function to render test card
            const renderTestCard = (test) => {
                const duration = test.data.duration || '';
                const timestamp = test.timestamp || '';
                const chartId = 'labMonitor-chart-' + test.category + '-' + test.level + '-' + Date.now();

                const cardHtml = `
                    <div class="test-card clickable" style="cursor: pointer; position: relative;" onclick="showReportTestDetails('${test.category}', '${test.level}')">
                        <button class="trend-btn" onclick="event.stopPropagation(); showReportTrend('${test.category}', '${test.level}', '${test.title}')" 
                            style="position: absolute; top: 15px; right: 15px; padding: 8px 16px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3); z-index: 10;">üìà Trend</button>
                        ${timestamp ? `<span class="test-time">${timestamp}</span>` : ''}
                        <h3>${test.title}${test.topology ? ` <span class="test-label" style="display: inline-block; background: rgba(92, 184, 92, 0.2); color: #5cb85c; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 8px;">(${test.topology})</span>` : ''}</h3>
                        ${duration ? `<div style="color: #95a5a6; font-size: 13px; text-align: center; margin-bottom: 15px;">${duration}</div>` : ''}
                        <div class="chart-container clickable-chart">
                            <canvas id="${chartId}"></canvas>
                        </div>
                    </div>
                `;

                // Defer chart drawing to after DOM update
                setTimeout(() => {
                    drawReportDonut(chartId, [test.data.passed, test.data.failed], ['Passed', 'Failed']);
                }, 10);

                return cardHtml;
            };

            // SAI Tests Row (T0, T1, T2 in same row - always show row if any test exists)
            if (summary.tests && summary.tests.sai) {
                const hasAnySai = ['t0', 't1', 't2'].some(level =>
                    summary.tests.sai[level] && summary.tests.sai[level].total > 0
                );
                if (hasAnySai) {
                    html += '<div class="test-grid">';
                    ['t0', 't1', 't2'].forEach(level => {
                        if (summary.tests.sai[level] && summary.tests.sai[level].total > 0) {
                            const test = {
                                category: 'sai',
                                level: level,
                                title: `SAI Test ${level.toUpperCase()} (sai)`,
                                data: summary.tests.sai[level],
                                timestamp: summary.tests.sai[level].timestamp
                            };
                            html += renderTestCard(test);
                        } else {
                            // Empty placeholder to maintain 3-column grid
                            html += '<div class="test-card" style="opacity: 0; pointer-events: none;"></div>';
                        }
                    });
                    html += '</div>';
                }
            }

            // Agent HW Tests Row (T0, T1, T2 in same row - always show row if any test exists)
            if (summary.tests && summary.tests.agent_hw) {
                const hasAnyAgent = ['t0', 't1', 't2'].some(level =>
                    summary.tests.agent_hw[level] && summary.tests.agent_hw[level].total > 0
                );
                if (hasAnyAgent) {
                    html += '<div class="test-grid">';
                    ['t0', 't1', 't2'].forEach(level => {
                        if (summary.tests.agent_hw[level] && summary.tests.agent_hw[level].total > 0) {
                            const test = {
                                category: 'agent_hw',
                                level: level,
                                title: `SAI Agent HW ${level.toUpperCase()} Test (sai_agent)`,
                                data: summary.tests.agent_hw[level],
                                timestamp: summary.tests.agent_hw[level].timestamp
                            };
                            html += renderTestCard(test);
                        } else {
                            // Empty placeholder to maintain 3-column grid
                            html += '<div class="test-card" style="opacity: 0; pointer-events: none;"></div>';
                        }
                    });
                    html += '</div>';
                }
            }

            // Link Tests Row (T0, T1, T2 in same row - always show row if any test exists)
            if (summary.tests && summary.tests.link) {
                const hasAnyLink = ['t0', 't1', 't2'].some(level =>
                    summary.tests.link[level] && summary.tests.link[level].total > 0
                );
                if (hasAnyLink) {
                    html += '<div class="test-grid">';
                    ['t0', 't1', 't2'].forEach(level => {
                        if (summary.tests.link[level] && summary.tests.link[level].total > 0) {
                            const test = {
                                category: 'link',
                                level: level,
                                title: `Link Test ${level.toUpperCase()} (link_test)`,
                                data: summary.tests.link[level],
                                timestamp: summary.tests.link[level].timestamp,
                                topology: summary.tests.link[level].topology
                            };
                            html += renderTestCard(test);
                        } else {
                            // Empty placeholder to maintain 3-column grid
                            html += '<div class="test-card" style="opacity: 0; pointer-events: none;"></div>';
                        }
                    });
                    html += '</div>';
                }
            }

            // Link Test (from LINKTEST_LOG) - separate category
            if (summary.tests && summary.tests.link_test && summary.tests.link_test.default && summary.tests.link_test.default.total > 0) {
                html += '<div class="test-grid">';
                const test = {
                    category: 'link_test',
                    level: 'default',
                    title: 'Link Test',
                    data: summary.tests.link_test.default,
                    timestamp: summary.tests.link_test.default.timestamp
                };
                html += renderTestCard(test);
                html += '</div>';
            }

            // EVT Tests Row
            if (summary.tests && summary.tests.link) {
                const evtTests = [];
                const evtTypes = ['ev_optics_one', 'ev_optics_two', 'ev_copper', 'ev_default', 'ev_400g'];
                evtTypes.forEach(evtType => {
                    if (summary.tests.link[evtType] && summary.tests.link[evtType].total > 0) {
                        const evtName = evtType.replace('ev_', '').replace(/_/g, ' ').toUpperCase();
                        evtTests.push({
                            category: 'link',
                            level: evtType,
                            title: `Exit EVT (${evtName})`,
                            data: summary.tests.link[evtType],
                            timestamp: summary.tests.link[evtType].timestamp
                        });
                    }
                });
                if (evtTests.length > 0) {
                    html += '<div class="test-grid">';
                    evtTests.forEach(test => html += renderTestCard(test));
                    html += '</div>';
                }
            }

            content.innerHTML = html;
        }

        function showReportAllTestDetails() {
            if (!reportCurrentSummary) return;

            // Collect all test items, and annotate with category/level
            let allItems = [];
            if (reportCurrentSummary.tests) {
                ['sai', 'agent_hw', 'link', 'link_test'].forEach(category => {
                    if (reportCurrentSummary.tests[category]) {
                        Object.keys(reportCurrentSummary.tests[category]).forEach(level => {
                            const testData = reportCurrentSummary.tests[category][level];
                            if (testData && testData.items) {
                                // Attach category/level to each item for later use
                                testData.items.forEach(item => {
                                    item._category = category;
                                    item._level = level;
                                });
                                allItems = allItems.concat(testData.items);
                            }
                        });
                    }
                });
            }

            reportCurrentTestItems = allItems;
            reportCurrentCategory = null;
            reportCurrentLevel = null;
            reportCurrentSortFilter = reportCurrentSummary.all_tests.failed === 0 ? 'pass' : 'fail';

            document.getElementById('reportModalTestTitle').textContent = 'All Tests - Details';
            renderReportTestTable();
            document.getElementById('reportTestModal').style.display = 'flex';
        }

        function showReportTestDetails(category, level) {
            if (!reportCurrentSummary || !reportCurrentSummary.tests) return;

            const testData = reportCurrentSummary.tests[category] && reportCurrentSummary.tests[category][level];
            if (!testData) return;

            reportCurrentTestItems = testData.items || [];
            reportCurrentCategory = category;
            reportCurrentLevel = level;
            reportCurrentSortFilter = testData.failed === 0 ? 'pass' : 'fail';
            // Ensure lab and dut name are set for log detail API
            if (reportCurrentSummary) {
                window.reportCurrentLabName = reportCurrentSummary.lab_name || '';
                window.reportCurrentDutName = reportCurrentSummary.dut_name || '';
            }

            const levelNames = {
                't0': 'T0', 't1': 'T1', 't2': 'T2',
                'ev_default': 'EVT Default', 'ev_400g': 'EVT 400G',
                'ev_optics_one': 'EVT Optics One', 'ev_optics_two': 'EVT Optics Two',
                'ev_copper': 'EVT Copper'
            };
            const categoryNames = { 'sai': 'SAI', 'agent_hw': 'Agent HW', 'link': 'Link' };

            document.getElementById('reportModalTestTitle').textContent =
                `${categoryNames[category]} ${levelNames[level]} - Details`;

            renderReportTestTable();
            document.getElementById('reportTestModal').style.display = 'flex';
        }

        function renderReportTestTable() {
            const tbody = document.getElementById('reportTestDetailsBody');
            tbody.innerHTML = '';

            if (!reportCurrentTestItems || reportCurrentTestItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No test items found</td></tr>';
                return;
            }

            // Filter items based on current sort filter
            let filteredItems = reportCurrentTestItems;
            if (reportCurrentSortFilter === 'pass') {
                filteredItems = reportCurrentTestItems.filter(item => item.result === 'PASS');
            } else if (reportCurrentSortFilter === 'fail') {
                filteredItems = reportCurrentTestItems.filter(item => item.result === 'FAIL');
            }

            // Update sort button states
            document.querySelectorAll('#reportTestModal .sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('reportSort' + reportCurrentSortFilter.charAt(0).toUpperCase() + reportCurrentSortFilter.slice(1)).classList.add('active');

            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No items match the filter</td></tr>';
                return;
            }

            filteredItems.forEach((item, index) => {
                const row = document.createElement('tr');
                const resultClass = item.result === 'PASS' ? 'result-pass' : 'result-fail';

                // Generate note key based on DUT ID, date, category, level, and test name
                const noteKey = `note_${reportCurrentDutId}_${reportCurrentDate}_${reportCurrentCategory}_${reportCurrentLevel}_${item.name}`;
                const savedNote = getReportNote(noteKey);
                const hasNote = savedNote.length > 0;
                const btnClass = hasNote ? 'note-btn has-note' : 'note-btn';
                const btnText = hasNote ? 'üìù Edit' : '‚úèÔ∏è Add';
                const displayNote = savedNote.length > 50 ? savedNote.substring(0, 50) + '...' : savedNote;
                const noteDisplay = hasNote ? displayNote : '<span style="color: #7f8c8d; font-style: italic;">No note</span>';


                // Use per-item category/level if available (for All Tests), else fallback to current
                let itemCategory = item._category !== undefined ? item._category : reportCurrentCategory;
                let itemLevel = item._level !== undefined ? item._level : reportCurrentLevel;
                // Only show View button if both category and level are present
                const viewBtnHtml = (reportCurrentPlatform === 'MINIPACK3BA' && itemCategory && itemLevel) ? `
                    <td style="text-align: center;">
                        <button class="view-log-btn" 
                                onclick="viewReportTestLogDetail('${item.name.replace(/'/g, "\\'").replace(/"/g, "&quot;")}', '${itemCategory}', '${itemLevel}')" 
                                title="View detailed log report">
                            View
                        </button>
                    </td>
                ` : '<td></td>';

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td class="${resultClass}">${item.result}</td>
                    <td style="font-size: 12px; color: #95a5a6;">${noteDisplay}</td>
                    <td style="text-align: center;">
                        <button class="${btnClass}" 
                                data-note-key="${noteKey}"
                                onclick="openReportNoteEditor('${noteKey}', '${item.name.replace(/'/g, "\\'")}')"
                                title="${hasNote ? 'Click to edit note' : 'Click to add note'}">
                            ${btnText}
                        </button>
                    </td>
                    ${viewBtnHtml}
                `;
                tbody.appendChild(row);
            });
        }

        function reportSortTests(filter) {
            reportCurrentSortFilter = filter;
            renderReportTestTable();
        }

        function closeReportTestModal() {
            document.getElementById('reportTestModal').style.display = 'none';
        }

        // Note management functions
        let reportCurrentNoteKey = '';

        function getReportNote(noteKey) {
            return localStorage.getItem(noteKey) || '';
        }

        function saveReportNoteToStorage(noteKey, content) {
            if (content.trim() === '') {
                localStorage.removeItem(noteKey);
            } else {
                localStorage.setItem(noteKey, content);
            }
        }

        function openReportNoteEditor(noteKey, testName) {
            reportCurrentNoteKey = noteKey;
            document.getElementById('reportNoteTestName').textContent = testName;
            document.getElementById('reportNoteEditorTextarea').value = getReportNote(noteKey);
            document.getElementById('reportNoteEditorModal').style.display = 'flex';
        }

        function closeReportNoteEditor() {
            document.getElementById('reportNoteEditorModal').style.display = 'none';
            reportCurrentNoteKey = '';
        }

        function saveReportNote() {
            const content = document.getElementById('reportNoteEditorTextarea').value;
            saveReportNoteToStorage(reportCurrentNoteKey, content);
            closeReportNoteEditor();
            renderReportTestTable();
        }

        // CSV download function
        function downloadReportTableAsCSV() {
            if (!reportCurrentTestItems || reportCurrentTestItems.length === 0) {
                alert('No test data to download');
                return;
            }

            // Filter items based on current sort filter
            let filteredItems = reportCurrentTestItems;
            if (reportCurrentSortFilter === 'pass') {
                filteredItems = reportCurrentTestItems.filter(item => item.result === 'PASS');
            } else if (reportCurrentSortFilter === 'fail') {
                filteredItems = reportCurrentTestItems.filter(item => item.result === 'FAIL');
            }

            // Create CSV content
            let csvContent = '#,Test Name,Result,Note\n';
            filteredItems.forEach((item, index) => {
                const noteKey = `note_${reportCurrentDutId}_${reportCurrentDate}_${reportCurrentCategory}_${reportCurrentLevel}_${item.name}`;
                const note = getReportNote(noteKey).replace(/"/g, '""'); // Escape quotes
                csvContent += `${index + 1},"${item.name}","${item.result}","${note}"\n`;
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `test_details_${reportCurrentCategory}_${reportCurrentLevel}_${reportCurrentDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Log download function (placeholder)
        function downloadReportTestLog() {
            const labName = encodeURIComponent(window.reportCurrentLabName || '');
            const platform = encodeURIComponent(reportCurrentPlatform || '');
            const dutName = encodeURIComponent(window.reportCurrentDutName || '');
            const date = reportCurrentDate || '';
            const category = reportCurrentCategory || 'all';
            const level = reportCurrentLevel || 'all';

            if (!platform || !date) {
                alert('Missing platform or date information');
                return;
            }

            console.log('Downloading log:', { labName, platform, dutName, date, category, level });

            const url = `/api/lab_monitor/download_log/${labName}/${platform}/${dutName}/${date}/${category}/${level}`;

            // Create a temporary link element to trigger download
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Log viewing function for MINIPACK3BA (copied from dashboard)
        function viewReportTestLogDetail(testName, category, level) {
            // Show loading indicator
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loadingIndicator';
            loadingMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 20px 40px;
                border-radius: 12px;
                z-index: 10000;
                font-size: 16px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            `;
            loadingMsg.textContent = 'Loading full log content...';
            document.body.appendChild(loadingMsg);

            // Gather info for API
            const labName = window.reportCurrentLabName || '';
            const platform = reportCurrentPlatform;
            const dutName = window.reportCurrentDutName || '';
            const date = reportCurrentDate;

            // Call API to get full log content
            fetch(`/api/lab_monitor/test_log_detail/${encodeURIComponent(labName)}/${encodeURIComponent(platform)}/${encodeURIComponent(dutName)}/${encodeURIComponent(date)}/${encodeURIComponent(category)}/${encodeURIComponent(level)}/${encodeURIComponent(testName)}?full=true`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Failed to load log');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Remove loading indicator
                    document.body.removeChild(loadingMsg);

                    // Show modal with full log (no truncation)
                    showReportLogDetailModal(testName, data.status, category, level, data.log_content, data.log_size);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.body.removeChild(loadingMsg);
                    alert('Failed to load log: ' + error.message);
                });
        }

        function showReportLogDetailModal(testName, status, category, level, logContent, logSize) {
            // Create modal if not exists
            let modal = document.getElementById('reportLogDetailModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'reportLogDetailModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="width: calc(100vw - 40px); height: calc(100vh - 40px); max-width: calc(100vw - 40px); max-height: calc(100vh - 40px); margin: 0; display: flex; flex-direction: column; overflow: hidden;">
                        <div class="modal-header" style="flex-shrink: 0;">
                            <h2 id="reportLogDetailTitle">Test Log Detail</h2>
                            <span class="close" onclick="closeReportLogDetailModal()">&times;</span>
                        </div>
                        <div class="modal-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">
                            <div style="margin-bottom: 20px; flex-shrink: 0;">
                                <h3 style="margin: 0 0 10px 0; color: #5cb85c;">Test Information</h3>
                                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                                    <div style="display: flex; gap: 30px; flex-wrap: wrap; overflow-x: hidden;">
                                        <div style="overflow: hidden; text-overflow: ellipsis;"><strong style="color: #95a5a6;">Test Name:</strong> <span id="reportLogDetailTestName" style="color: white; margin-left: 10px; word-break: break-all;"></span></div>
                                        <div><strong style="color: #95a5a6;">Status:</strong> <span id="reportLogDetailStatus" style="margin-left: 10px; padding: 4px 12px; border-radius: 4px; font-weight: bold;"></span></div>
                                        <div><strong style="color: #95a5a6;">Category:</strong> <span id="reportLogDetailCategory" style="color: white; margin-left: 10px;"></span></div>
                                        <div><strong style="color: #95a5a6;">Level:</strong> <span id="reportLogDetailLevel" style="color: white; margin-left: 10px;"></span></div>
                                        <div><strong style="color: #95a5a6;">Size:</strong> <span id="reportLogDetailSize" style="color: white; margin-left: 10px;"></span></div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px; flex-shrink: 0;">
                                <h3 style="margin: 0 0 10px 0; color: #5cb85c;">Full Log Content <span style="font-size: 14px; color: #95a5a6; font-weight: normal;">(Use Ctrl+F to search)</span></h3>
                            </div>
                            <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column; min-height: 0;">
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; flex: 1; overflow-y: auto; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; word-break: break-word;">
                                    <div id="reportLogDetailContent" style="color: #ecf0f1;"></div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: center; padding-top: 15px; border-top: 2px solid rgba(92, 184, 92, 0.3); flex-shrink: 0;">
                                <button id="downloadReportLogTxtBtn" class="download-btn" onclick="downloadReportLogAsTxt()"
                                    style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); font-size: 16px; padding: 12px 32px; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Download TXT
                                </button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }

            // Set title
            document.getElementById('reportLogDetailTitle').textContent = 'Test Log Detail';

            // Set test information
            document.getElementById('reportLogDetailTestName').textContent = testName;

            const statusElem = document.getElementById('reportLogDetailStatus');
            statusElem.textContent = status;
            if (status === 'PASS') {
                statusElem.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                statusElem.style.color = 'white';
            } else if (status === 'FAIL') {
                statusElem.style.background = 'linear-gradient(135deg, #f44336 0%, #da190b 100%)';
                statusElem.style.color = 'white';
            } else {
                statusElem.style.background = 'linear-gradient(135deg, #ff9800 0%, #fb8c00 100%)';
                statusElem.style.color = 'white';
            }

            document.getElementById('reportLogDetailCategory').textContent = category;
            document.getElementById('reportLogDetailLevel').textContent = level;

            // Show log size
            const sizeKB = (logSize / 1024).toFixed(2);
            const sizeMB = (logSize / 1024 / 1024).toFixed(2);
            const sizeStr = logSize > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;
            document.getElementById('reportLogDetailSize').textContent = sizeStr;

            // Set full log content (no truncation)
            document.getElementById('reportLogDetailContent').textContent = logContent;

            // Store test name and full content for TXT download
            modal.dataset.testName = testName;
            modal.dataset.fullLogContent = logContent;

            // Show modal with flex display
            modal.style.display = 'flex';
        }

        function downloadReportLogAsTxt() {
            const modal = document.getElementById('reportLogDetailModal');
            const testName = modal.dataset.testName;
            const logContent = modal.dataset.fullLogContent;

            // Create blob and download
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${testName}_log.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function closeReportLogDetailModal() {
            document.getElementById('reportLogDetailModal').style.display = 'none';
        }

        // ===== Download Organized Report Function =====

        function downloadReportOrganizedReport() {
            const labName = reportCurrentLabName;
            const platform = reportCurrentPlatform;
            const dutName = reportCurrentDutName;
            const date = reportCurrentDate;

            if (!labName || !platform || !dutName || !date) {
                alert('‚ö†Ô∏è Please open a test report first');
                return;
            }

            // Find the download button
            const btn = event.target;
            const originalText = btn.innerHTML;

            // Disable button and show loading state
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Generating...';

            console.log(`Downloading organized report for ${labName} / ${platform} / ${dutName} / ${date}`);

            // Create a temporary link to trigger download
            const url = `/api/lab_monitor/download_organized/${labName}/${platform}/${dutName}/${date}`;

            // Use fetch to check if the request succeeds
            fetch(url, { method: 'GET' })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Failed to generate report');
                        });
                    }
                    // If successful, trigger the download
                    return response.blob().then(blob => {
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = downloadUrl;
                        a.download = `Organized_Report_${labName}_${platform}_${dutName}_${date}.tar.gz`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(downloadUrl);
                        document.body.removeChild(a);

                        console.log('‚úÖ Organized report downloaded successfully');
                        btn.innerHTML = '‚úÖ Downloaded!';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    });
                })
                .catch(error => {
                    console.log(`ERROR: Failed to download organized report - ${error.message}`);
                    alert(`‚ùå Failed to generate organized report:\n${error.message}`);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        // ===== Trend Functions =====

        function showReportTrend(category, level, testName) {
            reportCurrentTrendType = 'case';
            reportCurrentTrendCategory = category;
            reportCurrentTrendLevel = level;
            reportCurrentTrendRange = 'week'; // Default to week

            // Set modal title
            document.getElementById('reportTrendModalTitle').textContent = `${testName} - Trend (Last 7 Days)`;

            // Show modal
            document.getElementById('reportTrendModal').style.display = 'flex';
            document.getElementById('reportTrendDetailsSection').style.display = 'none';

            // Set button states
            document.querySelectorAll('#reportTrendModal .modal-controls .sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('reportTrendWeek').classList.add('active');

            // Load trend data
            loadReportTrendData();
        }

        function closeReportTrendModal() {
            document.getElementById('reportTrendModal').style.display = 'none';
        }

        function closeReportTrendDetails() {
            document.getElementById('reportTrendDetailsSection').style.display = 'none';
            document.getElementById('reportTrendDiffSection').style.display = 'none';
            // Also hide the top button
            document.getElementById('reportTopCloseDetailsContainer').style.display = 'none';
        }

        // --- Trend Diff Feature ---

        function closeReportTrendDiff() {
            document.getElementById('reportTrendDiffSection').style.display = 'none';
        }

        function showReportTrendDiff(dateStr) {
            const diffSection = document.getElementById('reportTrendDiffSection');
            const loading = document.getElementById('reportTrendDiffLoading');
            const content = document.getElementById('reportTrendDiffContent');
            const newFailBody = document.getElementById('reportDiffNewFailBody');
            const fixedBody = document.getElementById('reportDiffFixedBody');

            if (!reportCurrentDutId) {
                alert('No DUT selected');
                return;
            }

            diffSection.style.display = 'block';
            loading.style.display = 'block';
            content.style.display = 'none';

            // Calculate previous day
            const currDate = new Date(dateStr);
            const prevDate = new Date(currDate);
            prevDate.setDate(currDate.getDate() - 1);

            const prevDateStr = prevDate.toISOString().split('T')[0];

            console.log(`Requesting diff for DUT ${reportCurrentDutId}: ${dateStr} vs ${prevDateStr}`);

            // /api/lab_monitor/dut/<dut_id>/dashboard/diff/<date_curr>/<date_prev>
            fetch(`/api/lab_monitor/dut/${reportCurrentDutId}/dashboard/diff/${dateStr}/${prevDateStr}`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    if (!data.success) {
                        alert('Error loading diff: ' + (data.error || 'Unknown error'));
                        diffSection.style.display = 'none';
                        return;
                    }

                    const diff = data.diff;
                    content.style.display = 'block';

                    // Populate New Failures
                    const newFailContainer = document.getElementById('reportDiffNewFailBody').closest('div').closest('div');
                    document.getElementById('reportDiffNewFailCount').textContent = diff.stats.new_failures_count;
                    newFailBody.innerHTML = '';
                    if (diff.new_failures.length === 0) {
                        newFailContainer.style.display = 'none';
                    } else {
                        newFailContainer.style.display = 'block';
                        diff.new_failures.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="font-weight: bold;">${item.name}</td>
                                <td>${item.category} / ${item.level}</td>
                                <td><span class="status-badge status-fail">FAIL</span> <span style="font-size: 0.8em; color: #888;">(Prev: ${item.prev_result})</span></td>
                                <td>Current</td>
                            `;
                            newFailBody.appendChild(row);
                        });
                    }

                    // Populate Fixed
                    const fixedContainer = document.getElementById('reportDiffFixedBody').closest('div').closest('div');
                    document.getElementById('reportDiffFixedCount').textContent = diff.stats.fixed_count;
                    fixedBody.innerHTML = '';
                    if (diff.fixed.length === 0) {
                        fixedContainer.style.display = 'none';
                    } else {
                        fixedContainer.style.display = 'block';
                        diff.fixed.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="font-weight: bold;">${item.name}</td>
                                <td>${item.category} / ${item.level}</td>
                                <td><span class="status-badge status-pass">PASS</span> <span style="font-size: 0.8em; color: #888;">(Prev: ${item.prev_result})</span></td>
                                <td>Current</td>
                            `;
                            fixedBody.appendChild(row);
                        });
                    }

                    // Populate Test Changes (Added/Removed)
                    document.getElementById('reportDiffAddedCount').textContent = diff.stats.added_count || 0;
                    document.getElementById('reportDiffRemovedCount').textContent = diff.stats.removed_count || 0;
                    const changesBody = document.getElementById('reportDiffChangesBody');
                    changesBody.innerHTML = '';

                    const addedTests = diff.added_tests || [];
                    const removedTests = diff.removed_tests || [];

                    if (addedTests.length === 0 && removedTests.length === 0) {
                        changesBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: #888;">No test changes found</td></tr>';
                    } else {
                        // Added Tests
                        addedTests.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="font-weight: bold;">${item.name}</td>
                                <td>${item.category} / ${item.level}</td>
                                <td><span class="status-badge" style="background-color: #5bc0de;">ADDED</span></td>
                                <td>${item.curr_result}</td>
                            `;
                            changesBody.appendChild(row);
                        });

                        // Removed Tests
                        removedTests.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="font-weight: bold; color: #888;">${item.name}</td>
                                <td style="color: #888;">${item.category} / ${item.level}</td>
                                <td><span class="status-badge" style="background-color: #999;">REMOVED</span></td>
                                <td style="color: #888;">${item.prev_result}</td>
                            `;
                            changesBody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    loading.style.display = 'none';
                    alert('Error loading diff data: ' + error);
                    console.error('Diff error:', error);
                    diffSection.style.display = 'none';
                });
        }

        function changeReportTrendRange(range) {
            reportCurrentTrendRange = range;

            // Update button states
            document.querySelectorAll('#reportTrendModal .modal-controls .sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`reportTrend${range.charAt(0).toUpperCase() + range.slice(1)}`).classList.add('active');

            // Reload trend data with new range
            loadReportTrendData();
        }

        function loadReportTrendData() {
            const endDate = reportCurrentDate || new Date().toISOString().split('T')[0];

            // Update modal title based on range
            const rangeLabels = {
                'week': 'Last 7 Days',
                'month': 'Last 30 Days',
                'year': 'Last Year'
            };

            const testName = document.getElementById('reportTrendModalTitle').textContent.split(' - Trend')[0];
            document.getElementById('reportTrendModalTitle').textContent = `${testName} - Trend (${rangeLabels[reportCurrentTrendRange]})`;

            // Fetch trend data from API
            // For "all tests", use a different endpoint without category/level
            let apiUrl;
            if (reportCurrentTrendCategory === 'all' && reportCurrentTrendLevel === 'all') {
                // All tests trend - use simpler endpoint
                apiUrl = `/api/lab_monitor/dut/${reportCurrentDutId}/trend/${endDate}?range=${reportCurrentTrendRange}`;
            } else {
                // Individual test trend
                apiUrl = `/api/lab_monitor/dut/${reportCurrentDutId}/trend/${reportCurrentTrendCategory}/${reportCurrentTrendLevel}/${endDate}?range=${reportCurrentTrendRange}`;
            }

            fetch(apiUrl)
                .then(r => r.json())
                .then(data => {
                    reportCurrentTrendData = data;
                    renderReportTrendChart(data, testName);
                })
                .catch(err => {
                    console.error('Error loading trend data:', err);
                    alert('Failed to load trend data');
                });
        }

        function generateReportCommitBackgrounds(data) {
            const annotations = {};
            const commitGroups = [];
            let currentCommit = null;
            let startIndex = 0;

            // Define a color palette for different commits
            const colors = [
                'rgba(255, 99, 132, 0.05)',   // pink
                'rgba(54, 162, 235, 0.05)',   // blue
                'rgba(255, 206, 86, 0.05)',   // yellow
                'rgba(75, 192, 192, 0.05)',   // teal
                'rgba(153, 102, 255, 0.05)',  // purple
                'rgba(255, 159, 64, 0.05)',   // orange
                'rgba(199, 199, 199, 0.05)',  // grey
                'rgba(83, 102, 255, 0.05)',   // indigo
                'rgba(255, 99, 255, 0.05)',   // magenta
                'rgba(99, 255, 132, 0.05)'    // green
            ];

            let colorIndex = 0;

            // Group consecutive data points with the same commit ID
            for (let i = 0; i < data.length; i++) {
                const commitId = data[i].version_info?.FBOSS_COMMIT_ID;

                if (commitId && commitId !== currentCommit) {
                    // If we have a previous group, save it
                    if (currentCommit !== null) {
                        commitGroups.push({
                            commitId: currentCommit,
                            startIndex: startIndex,
                            endIndex: i - 1,
                            color: colors[colorIndex % colors.length]
                        });
                        colorIndex++;
                    }

                    // Start new group
                    currentCommit = commitId;
                    startIndex = i;
                } else if (!commitId && currentCommit !== null) {
                    // End current group if commit ID becomes null
                    commitGroups.push({
                        commitId: currentCommit,
                        startIndex: startIndex,
                        endIndex: i - 1,
                        color: colors[colorIndex % colors.length]
                    });
                    colorIndex++;
                    currentCommit = null;
                }
            }

            // Don't forget the last group
            if (currentCommit !== null) {
                commitGroups.push({
                    commitId: currentCommit,
                    startIndex: startIndex,
                    endIndex: data.length - 1,
                    color: colors[colorIndex % colors.length]
                });
            }

            // Create annotation boxes for each commit group
            commitGroups.forEach((group, idx) => {
                annotations[`commit-${idx}`] = {
                    type: 'box',
                    xMin: group.startIndex - 0.5,
                    xMax: group.endIndex + 0.5,
                    backgroundColor: group.color,
                    borderColor: group.color.replace('0.05', '0.3'),
                    borderWidth: 1,
                    label: {
                        display: true,
                        content: `Commit: ${group.commitId.substring(0, 7)}`,
                        position: 'start',
                        color: '#ffffff',
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        font: {
                            size: 10
                        },
                        padding: 4
                    }
                };
            });

            return annotations;
        }


        function renderReportTrendChart(data, testName) {
            const ctx = document.getElementById('reportTrendChart').getContext('2d');

            // Destroy existing chart if it exists
            if (reportTrendChart) {
                reportTrendChart.destroy();
            }

            // Prepare labels and adjustable point radius
            const dataLength = data.length;
            let labels, pointRadius, pointHoverRadius;

            if (dataLength <= 7) {
                // Week view: show month/day
                labels = data.map(d => {
                    const date = new Date(d.date);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });
                pointRadius = 6;
                pointHoverRadius = 8;
            } else if (dataLength <= 30) {
                // Month view
                labels = data.map(d => {
                    const date = new Date(d.date);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });
                pointRadius = 4;
                pointHoverRadius = 6;
            } else {
                // Year view
                labels = data.map(d => {
                    const date = new Date(d.date);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });
                pointRadius = 2;
                pointHoverRadius = 4;
            }

            // Handle both "all tests" format (d.all_tests.passed) and individual test format (d.passed)
            const passedData = data.map(d => d.all_tests ? d.all_tests.passed : (d.passed || 0));
            const failedData = data.map(d => d.all_tests ? d.all_tests.failed : (d.failed || 0));
            const totalData = data.map(d => d.all_tests ? d.all_tests.total : (d.total || 0));

            // Extract duration data (convert to minutes for display)
            const durationData = data.map(d => {
                let totalMinutes = 0;

                // Case 1: Individual test with direct duration field
                if (d.duration) {
                    const hours = d.duration.match(/(\d+)h/);
                    const minutes = d.duration.match(/(\d+)m/);
                    if (hours) totalMinutes += parseInt(hours[1]) * 60;
                    if (minutes) totalMinutes += parseInt(minutes[1]);
                    return totalMinutes || totalMinutes === 0 ? totalMinutes : null;
                }

                // Case 2: All tests summary with d.tests
                if (d.tests && Object.keys(d.tests).length > 0) {
                    for (const category in d.tests) {
                        for (const level in d.tests[category]) {
                            const duration = d.tests[category][level].duration;
                            if (duration) {
                                // Parse duration string like "2h 30m" or "45m"
                                const hours = duration.match(/(\d+)h/);
                                const minutes = duration.match(/(\d+)m/);
                                if (hours) totalMinutes += parseInt(hours[1]) * 60;
                                if (minutes) totalMinutes += parseInt(minutes[1]);
                            }
                        }
                    }
                    return totalMinutes || null;
                }

                return null;
            });

            // Generate commit background annotations
            const commitAnnotations = generateReportCommitBackgrounds(data);

            // Create chart
            reportTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Passed',
                            data: passedData,
                            backgroundColor: 'rgba(92, 184, 92, 0.2)',
                            borderColor: 'rgba(92, 184, 92, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: pointRadius,
                            pointHoverRadius: pointHoverRadius,
                            pointBackgroundColor: 'rgba(92, 184, 92, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Failed',
                            data: failedData,
                            backgroundColor: 'rgba(217, 83, 79, 0.2)',
                            borderColor: 'rgba(217, 83, 79, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: pointRadius,
                            pointHoverRadius: pointHoverRadius,
                            pointBackgroundColor: 'rgba(217, 83, 79, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Total',
                            data: totalData,
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: pointRadius,
                            pointHoverRadius: pointHoverRadius,
                            pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Time',
                            data: durationData,
                            backgroundColor: 'rgba(255, 179, 102, 0.2)',
                            borderColor: 'rgba(255, 179, 102, 1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: pointRadius - 1,
                            pointHoverRadius: pointHoverRadius - 1,
                            pointBackgroundColor: 'rgba(255, 179, 102, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y1',
                            hidden: true // Keep hidden by default like dashboard
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'point',
                        intersect: true
                    },
                    plugins: {
                        annotation: {
                            annotations: commitAnnotations
                        },
                        datalabels: {
                            display: function (context) {
                                // Don't show labels for Time dataset (index 3)
                                return context.datasetIndex !== 3;
                            },
                            color: '#ffffff',
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            align: 'top',
                            offset: 6,
                            formatter: (value, context) => {
                                return value;
                            },
                            backgroundColor: function (context) {
                                const datasetIndex = context.datasetIndex;
                                if (datasetIndex === 0) return 'rgba(92, 184, 92, 0.7)';
                                if (datasetIndex === 1) return 'rgba(217, 83, 79, 0.7)';
                                return 'rgba(52, 152, 219, 0.7)';
                            },
                            borderRadius: 4,
                            padding: 4
                        },
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff',
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#5cb85c',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: (context) => {
                                    const date = data[context[0].dataIndex].date;
                                    return date;
                                },
                                afterBody: (context) => {
                                    const index = context[0].dataIndex;
                                    const day = data[index];
                                    const total = day.all_tests ? day.all_tests.total : (day.total || 0);
                                    const binFile = (day.version_info && day.version_info.FBOSS_BINARY) ? day.version_info.FBOSS_BINARY : 'N/A';
                                    const commitId = (day.version_info && day.version_info.FBOSS_COMMIT_ID) ? day.version_info.FBOSS_COMMIT_ID.substring(0, 8) : 'N/A';
                                    const duration = durationData[index];
                                    const durationText = duration !== null ? `${Math.floor(duration / 60)}h ${duration % 60}m` : 'N/A';

                                    return `Total Tests: ${total}\nExecution Time: ${durationText}\nBin File: ${binFile}\nCommit ID: ${commitId}\n\nüí° Click on a point to see details`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Test Count',
                                color: '#ffffff',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: {
                                color: '#ffffff',
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Time (minutes)',
                                color: '#ffb366',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: {
                                color: '#ffb366',
                                font: { size: 12 },
                                callback: function (value) {
                                    return Math.floor(value);
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const datasetIndex = elements[0].datasetIndex;
                            const dateData = data[index];
                            // Determine which line was clicked: 0=passed (green), 1=failed (red), 2=total (blue)
                            const isTotalPoint = (datasetIndex === 2);
                            const filterType = datasetIndex === 0 ? 'PASS' : (datasetIndex === 1 ? 'FAIL' : null);
                            showReportTrendDetails(dateData, filterType, isTotalPoint);
                        }
                    }
                }
            });

            // Auto-show diff for the latest data point
            if (data.length > 0) {
                const lastIndex = data.length - 1;
                const latestData = data[lastIndex];
                // Simulate clicking the "Total" point (isTotalPoint = true)
                showReportTrendDetails(latestData, null, true);

                // Show top close button
                document.getElementById('reportTopCloseDetailsContainer').style.display = 'block';

                // Ensure focus stays on chart
                const modalBody = document.querySelector('#reportTrendModal .modal-body'); // Assuming structure similar to dashboard
                if (modalBody) modalBody.scrollTop = 0;
            }
        }

        function showReportTrendDetails(dateData, filterType = null, isTotalPoint = false) {
            reportCurrentTrendDate = dateData.date;

            // Always hide first
            const diffSection = document.getElementById('reportTrendDiffSection');
            diffSection.style.display = 'none';

            // Auto-open diff if "Total" point
            if (isTotalPoint) {
                showReportTrendDiff(reportCurrentTrendDate);
            }
            // Show top close button
            document.getElementById('reportTopCloseDetailsContainer').style.display = 'block';

            // Show details section
            document.getElementById('reportTrendDetailsSection').style.display = 'block';

            // Update title to show filter type
            const filterText = filterType ? ` - ${filterType} Only` : '';
            document.getElementById('reportTrendDetailTitle').textContent = `Test Details for ${dateData.date}${filterText}`;

            // Populate test items table
            const tbody = document.getElementById('reportTrendDetailsBody');
            tbody.innerHTML = '';

            // Collect test items - handle both individual test trend and all tests trend
            let allItems = [];

            if (dateData.items && dateData.items.length > 0) {
                // Individual test case trend - has items directly
                allItems = dateData.items;
            } else if (dateData.tests) {
                // All tests trend - need to flatten the tests structure
                for (const category in dateData.tests) {
                    for (const level in dateData.tests[category]) {
                        const testData = dateData.tests[category][level];
                        if (testData.items && testData.items.length > 0) {
                            allItems = allItems.concat(testData.items);
                        }
                    }
                }
            }

            // Filter items based on which line was clicked
            if (filterType) {
                allItems = allItems.filter(item => item.result === filterType);
            }

            if (allItems.length > 0) {
                allItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const resultClass = item.result === 'PASS' ? 'result-pass' : 'result-fail';
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td class="${resultClass}">${item.result}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                const noDataMsg = filterType ? `No ${filterType} tests for this date` : 'No test data available for this date';
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: #95a5a6;">${noDataMsg}</td></tr>`;
            }

            // Show version info if available
            if (dateData.version_info) {
                document.getElementById('reportTrendVersionInfoSection').style.display = 'block';
                const versionContent = document.getElementById('reportTrendVersionContent');
                versionContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 15px; line-height: 1.8;">
                        ${Object.entries(dateData.version_info).map(([key, value]) => `
                            <div style="padding: 8px; background: rgba(255,255,255,0.03); border-radius: 4px;">
                                <div style="color: #95a5a6; font-size: 12px; margin-bottom: 4px;">${key}</div>
                                <div style="color: white; font-size: 13px; word-break: break-all;">${value || 'N/A'}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('reportTrendVersionInfoSection').style.display = 'none';
            }
        }

        function exportReportTrendToExcel() {
            if (!reportCurrentTrendData || reportCurrentTrendData.length === 0) {
                alert('No trend data available to export');
                return;
            }

            // Create workbook and worksheet
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Trend Data');

            // Add title
            const testName = document.getElementById('reportTrendModalTitle').textContent.split(' - Trend')[0];
            worksheet.mergeCells('A1:H1');
            const titleCell = worksheet.getCell('A1');
            titleCell.value = `${testName} - Trend Report`;
            titleCell.font = { size: 16, bold: true };
            titleCell.alignment = { horizontal: 'center', vertical: 'middle' };

            // Add headers
            worksheet.addRow(['Date', 'Passed', 'Failed', 'Total', 'Status', 'Bin File', 'Commit', 'SAI Version']);
            const headerRow = worksheet.getRow(2);
            headerRow.font = { bold: true };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF4CAF50' }
            };

            // Add data
            reportCurrentTrendData.forEach(item => {
                const status = item.failed === 0 ? 'PASS' : 'FAIL';
                worksheet.addRow([
                    item.date,
                    item.passed,
                    item.failed,
                    item.total,
                    status,
                    item.version_info?.BIN_FILE || '',
                    item.version_info?.FBOSS_COMMIT_ID || '',
                    item.version_info?.SAI_VERSION || ''
                ]);
            });

            // Auto-fit columns
            worksheet.columns.forEach(column => {
                column.width = 15;
            });

            // Download file
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${testName}_Trend_${new Date().toISOString().split('T')[0]}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }
    </script>
</body>

</html>